<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åœ–ç‰‡æ–‡å­—ç§»é™¤ PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; }
        .drop-zone-active { border-color: #3b82f6 !important; background-color: rgba(59, 130, 246, 0.1) !important; transform: scale(1.02); }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .result-card { transition: all 0.3s ease; }
        .result-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .progress-bar { transition: width 0.3s ease; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* Checkbox Custom Style */
        .custom-checkbox:checked + div {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.2);
        }
        .custom-checkbox:checked + div .check-icon {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="text-white pb-20">
    <div class="max-w-6xl mx-auto px-4 py-12">
        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-3">
                AI åœ–ç‰‡æ–‡å­—ç§»é™¤ <span class="text-blue-400">PRO</span>
            </h1>
            <p class="text-slate-400 text-lg">ä¸Šå‚³ PDF æˆ–åœ–ç‰‡ â†’ é¸æ“‡é é¢ â†’ è‡ªå‹•å»å­— â†’ å°å‡ºé›™ PPTX</p>
            <div class="flex items-center justify-center gap-4 mt-4">
                <span class="flex items-center gap-2 text-xs text-blue-400">
                    <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
                    Powered by Gemini 2.5
                </span>
            </div>
            <div class="mt-6 inline-flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                <span class="text-emerald-400 text-xs font-bold">v2.2</span>
                <span class="text-slate-300 text-xs">è»Ÿé‡ç½®ä¿ç•™ API Key + é€Ÿåº¦å„ªåŒ– + IMAGE_RECITATION ä¿®å¾©</span>
            </div>
            <div id="api-key-status" class="mt-6 mx-auto max-w-2xl rounded-2xl p-4 text-sm hidden">
                <!-- å‹•æ…‹é¡¯ç¤º API Key ç‹€æ…‹ -->
            </div>
        </header>

        <!-- ä¸»ä¸Šå‚³å€ -->
        <section id="upload-section" class="mb-10 transition-all duration-300">
            <div id="drop-zone" class="glass rounded-3xl p-16 text-center cursor-pointer hover:border-blue-500/50 transition-all duration-300 group">
                <input type="file" id="file-input" class="hidden" accept="application/pdf,image/*" multiple>
                <div class="w-20 h-20 bg-blue-500/20 text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <p class="text-2xl font-bold text-white mb-2">æ‹–æ”¾ PDF æˆ–åœ–ç‰‡</p>
                <p class="text-slate-400">é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆ</p>
                <div id="lib-warning" class="mt-4 text-xs text-amber-400 hidden">è­¦å‘Šï¼šçµ„ä»¶å°šæœªå°±ç·’ï¼Œè«‹ç¨å€™...</div>
            </div>
        </section>

        <!-- é¸æ“‡é é¢å€ -->
        <section id="selection-section" class="hidden mb-10 animate-fade-in">
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                <div>
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <span class="bg-blue-500 w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                        é¸æ“‡è¦è™•ç†çš„é é¢
                    </h2>
                    <p class="text-slate-400 text-sm mt-1 ml-10">åƒ…å‹¾é¸éœ€è¦çš„é é¢ä»¥ç¯€çœæ™‚é–“</p>
                </div>
                <div class="flex gap-3">
                    <button id="select-all-btn" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm font-bold transition">å…¨é¸</button>
                    <button id="deselect-all-btn" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm font-bold transition">å…¨å–æ¶ˆ</button>
                    <button id="start-process-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/20 transition flex items-center gap-2">
                        é–‹å§‹è™•ç† (<span id="selected-count">0</span>)
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </div>
            </div>

            <div id="selection-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 custom-scrollbar max-h-[60vh] overflow-y-auto p-2">
                <!-- ç¸®åœ–å°‡ç”Ÿæˆæ–¼æ­¤ -->
            </div>
        </section>

        <!-- è™•ç†é€²åº¦å€ -->
        <section id="progress-section" class="hidden mb-10">
            <div class="glass rounded-3xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="loader"></div>
                        <div>
                            <p id="progress-title" class="font-bold text-lg">è™•ç†ä¸­...</p>
                            <p id="progress-detail" class="text-sm text-slate-400">åˆ†æä¸­</p>
                        </div>
                    </div>
                    <span id="progress-count" class="text-2xl font-black text-blue-400">0/0</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                    <div id="progress-bar" class="progress-bar bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </section>

        <!-- çµæœå€ -->
        <section id="results-section" class="hidden">
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4 border-t border-slate-700 pt-8">
                <div>
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <span class="bg-emerald-500 w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
                        è™•ç†çµæœ
                    </h2>
                </div>
                <div class="flex items-center gap-3 flex-wrap">
                    <select id="ratio-select" class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-sm font-bold outline-none">
                        <option value="16:9">16:9 æ©«å¼</option>
                        <option value="9:16">9:16 ç›´å¼</option>
                        <option value="4:3">4:3 æ¨™æº–</option>
                    </select>
                    <button id="export-combined-btn" class="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                        åˆä½µ PPTX â­
                    </button>
                    <button id="reset-btn" class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-4 py-2.5 rounded-xl font-bold transition">é‡æ–°é–‹å§‹</button>
                </div>
            </div>
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 custom-scrollbar"></div>
        </section>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl opacity-0 transition-all pointer-events-none z-50 text-sm font-bold border border-slate-700"></div>

    <!-- API Key è¨­å®šæ¨¡æ…‹è¦–çª— -->
    <div id="api-key-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass rounded-3xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-black">ğŸ”‘ è¨­å®š Gemini API Key</h2>
                <button id="close-modal" class="text-slate-400 hover:text-white transition text-2xl">&times;</button>
            </div>

            <div class="space-y-6">
                <!-- æ­¥é©Ÿèªªæ˜ -->
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-5">
                    <h3 class="font-bold text-blue-400 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        ç‚ºä»€éº¼éœ€è¦ API Keyï¼Ÿ
                    </h3>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        æœ¬å·¥å…·ä½¿ç”¨ Google Gemini AI é€²è¡Œåœ–ç‰‡è™•ç†ã€‚ç‚ºäº†è®“æ¯ä½ä½¿ç”¨è€…éƒ½èƒ½äº«æœ‰ç©©å®šçš„æœå‹™å“è³ªï¼Œè«‹ä½¿ç”¨æ‚¨è‡ªå·±çš„ API Keyã€‚
                        <strong class="text-blue-400">Google æä¾›å…è²»é¡åº¦</strong>ï¼Œæ¯æœˆå¯è™•ç†å¤§é‡åœ–ç‰‡ï¼Œå®Œå…¨å…è²»ï¼
                    </p>
                </div>

                <!-- ç”³è«‹æ­¥é©Ÿ -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-lg">ğŸ“ å¦‚ä½•å–å¾— API Keyï¼ˆ3 æ­¥é©Ÿï¼‰</h3>
                        <span class="text-xs text-slate-400">é¦–æ¬¡ç”³è«‹æˆ–æ‰¾å›æ—¢æœ‰çš„ Key</span>
                    </div>

                    <div class="space-y-3">
                        <div class="flex gap-4 bg-slate-700/30 rounded-xl p-4">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center font-bold">1</div>
                            <div class="flex-1">
                                <p class="font-bold mb-1">å‰å¾€ Google AI Studio</p>
                                <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-400 hover:text-blue-300 underline text-sm flex items-center gap-1">
                                    https://aistudio.google.com/apikey
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                </a>
                                <p class="text-xs text-slate-400 mt-1">ä½¿ç”¨ä½ çš„ Google å¸³è™Ÿç™»å…¥</p>
                            </div>
                        </div>

                        <div class="flex gap-4 bg-slate-700/30 rounded-xl p-4">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center font-bold">2</div>
                            <div class="flex-1">
                                <p class="font-bold mb-1">å–å¾—æˆ–å»ºç«‹ API Key</p>
                                <p class="text-sm text-slate-300">
                                    â€¢ <strong>å·²æœ‰ Keyï¼Ÿ</strong>åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸¦é»æ“Šã€Œè¤‡è£½ã€åœ–ç¤º<br>
                                    â€¢ <strong>é¦–æ¬¡ä½¿ç”¨ï¼Ÿ</strong>é»æ“Šã€ŒCreate API Keyã€å»ºç«‹æ–°çš„
                                </p>
                                <p class="text-xs text-slate-400 mt-1">ğŸ’¡ å»ºç«‹æ™‚é¸æ“‡ã€ŒCreate API key in new projectã€å³å¯</p>
                            </div>
                        </div>

                        <div class="flex gap-4 bg-slate-700/30 rounded-xl p-4">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center font-bold">3</div>
                            <div class="flex-1">
                                <p class="font-bold mb-1">è¤‡è£½ä¸¦è²¼ä¸Š API Key</p>
                                <p class="text-sm text-slate-300">
                                    å°‡æ‚¨çš„ API Key è²¼ä¸Šåˆ°ä¸‹æ–¹æ¬„ä½ï¼Œé»æ“Šã€Œ<strong class="text-blue-400">ğŸ’¾ å„²å­˜ä¸¦é–‹å§‹ä½¿ç”¨</strong>ã€å³å¯
                                </p>
                                <p class="text-xs text-emerald-400 mt-1">âœ“ API Key åªæœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œéå¸¸å®‰å…¨</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Key è¼¸å…¥ -->
                <div>
                    <label class="block text-sm font-bold mb-2">æ‚¨çš„ API Key</label>
                    <div class="flex gap-2">
                        <input
                            type="password"
                            id="api-key-input"
                            placeholder="è²¼ä¸Šä½ çš„ API Keyï¼ˆä»¥ AIza é–‹é ­ï¼‰"
                            class="flex-1 bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 outline-none focus:border-blue-500 transition font-mono text-sm"
                        >
                        <button id="toggle-visibility" class="px-4 bg-slate-700 hover:bg-slate-600 rounded-xl transition" title="é¡¯ç¤º/éš±è—">
                            ğŸ‘ï¸
                        </button>
                    </div>
                    <div class="flex items-start gap-2 mt-2 text-xs">
                        <svg class="w-4 h-4 inline text-slate-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        <p class="text-slate-400">
                            æ‚¨çš„ API Key åƒ…å„²å­˜åœ¨æœ¬åœ°ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚
                            <span class="text-blue-400 cursor-pointer hover:underline" id="show-existing-key-tip">å·²æœ‰ API Key åœ¨å“ªæ‰¾ï¼Ÿ</span>
                        </p>
                    </div>
                </div>

                <!-- å„²å­˜æŒ‰éˆ• -->
                <div class="flex gap-3 pt-4">
                    <button id="save-api-key" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition">
                        ğŸ’¾ å„²å­˜ä¸¦é–‹å§‹ä½¿ç”¨
                    </button>
                </div>

                <!-- å…è²»é¡åº¦èªªæ˜ -->
                <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 text-xs text-slate-300">
                    <p class="font-bold text-emerald-400 mb-1">âœ¨ å…è²»é¡åº¦èªªæ˜</p>
                    <p>Gemini API å…è²»æ–¹æ¡ˆæ¯åˆ†é˜å¯è™•ç† 15 å¼µåœ–ç‰‡ï¼Œæ¯å¤© 1500 å¼µã€‚å°ä¸€èˆ¬ä½¿ç”¨ä¾†èªªç¶½ç¶½æœ‰é¤˜ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // èª¿è©¦ï¼šæª¢æŸ¥ localStorage å¯ç”¨æ€§
        try {
            localStorage.setItem('test', 'test');
            localStorage.removeItem('test');
            console.log('âœ“ localStorage å¯ç”¨');
        } catch (e) {
            console.error('âŒ localStorage ä¸å¯ç”¨:', e);
        }

        // API Key ç”±ç”¨æˆ¶åœ¨ä»‹é¢ä¸­è¼¸å…¥ï¼Œå„²å­˜åœ¨ localStorage
        let apiKey = localStorage.getItem('gemini_api_key') || "";
        console.log('é é¢è¼‰å…¥: å¾ localStorage è®€å– API Key');
        console.log('  - é•·åº¦:', apiKey.length);
        console.log('  - å‰8ç¢¼:', apiKey.substring(0, 8));
        console.log('  - æ˜¯å¦ç‚ºç©º:', apiKey === "");
        console.log('  - localStorage æ‰€æœ‰ key:', Object.keys(localStorage));

        // ä½¿ç”¨ç©©å®šç‰ˆæ¨¡å‹
        const MODEL_IMAGE_EDIT = "gemini-2.5-flash-image";  // åœ–åƒç”Ÿæˆ/ç·¨è¼¯
        const MODEL_TEXT_GEN = "gemini-2.5-flash";           // æ–‡å­—ç”Ÿæˆ (OCR)

        // ç‹€æ…‹ç®¡ç†
        let pendingItems = [];
        let results = [];

        function initPdfLibrary() {
            try {
                if (window.pdfjsLib) {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    return true;
                }
            } catch (e) { console.error(e); }
            document.getElementById('lib-warning').classList.remove('hidden');
            return false;
        }

        // UI å…ƒç´ 
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadSection = document.getElementById('upload-section');
        const selectionSection = document.getElementById('selection-section');
        const selectionGrid = document.getElementById('selection-grid');
        const progressSection = document.getElementById('progress-section');
        const resultsSection = document.getElementById('results-section');
        const progressBar = document.getElementById('progress-bar');
        const progressTitle = document.getElementById('progress-title');
        const progressDetail = document.getElementById('progress-detail');
        const progressCount = document.getElementById('progress-count');
        const resultsGrid = document.getElementById('results-grid');
        const toast = document.getElementById('toast');
        const selectedCountSpan = document.getElementById('selected-count');

        function showApiKeyModal() {
            const modal = document.getElementById('api-key-modal');
            const input = document.getElementById('api-key-input');
            if (modal) modal.classList.remove('hidden');
            if (input) {
                input.value = apiKey;
                input.focus();
            }
        }

        function hideApiKeyModal() {
            const modal = document.getElementById('api-key-modal');
            if (modal) modal.classList.add('hidden');
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            if (!input) {
                showToast('âŒ ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¼¸å…¥æ¬„ä½', true);
                console.error('saveApiKey: æ‰¾ä¸åˆ° api-key-input å…ƒç´ ');
                return;
            }

            const newKey = input.value.trim();
            console.log('saveApiKey: æº–å‚™å„²å­˜ API Keyï¼Œé•·åº¦:', newKey.length);

            if (!newKey) {
                showToast('è«‹è¼¸å…¥ API Key', true);
                return;
            }
            if (!newKey.startsWith('AIza')) {
                showToast('âš ï¸ API Key æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºï¼ˆæ‡‰ä»¥ AIza é–‹é ­ï¼‰ï¼Œä½†ä»å°‡å„²å­˜', true);
                console.warn('saveApiKey: API Key æ ¼å¼è­¦å‘Šï¼Œä½†ä»ç¹¼çºŒå„²å­˜');
            }

            // å…ˆæ›´æ–°å…¨åŸŸè®Šæ•¸
            apiKey = newKey;
            console.log('saveApiKey: å·²æ›´æ–°å…¨åŸŸè®Šæ•¸ apiKey');

            // ä¿å­˜åˆ° localStorage
            try {
                localStorage.setItem('gemini_api_key', apiKey);
                console.log('saveApiKey: localStorage.setItem åŸ·è¡Œå®Œæˆ');

                // ç«‹å³é©—è­‰
                const saved = localStorage.getItem('gemini_api_key');
                console.log('saveApiKey: ç«‹å³é©—è­‰è®€å–');
                console.log('  - å„²å­˜çš„å€¼é•·åº¦:', saved ? saved.length : 0);
                console.log('  - èˆ‡åŸå€¼ç›¸åŒ:', saved === apiKey);
                console.log('  - localStorage æ‰€æœ‰ keys:', Object.keys(localStorage));

                if (saved !== apiKey) {
                    throw new Error('localStorage é©—è­‰å¤±æ•—ï¼šè®€å–å€¼èˆ‡å„²å­˜å€¼ä¸åŒ');
                }
            } catch (e) {
                console.error('saveApiKey: localStorage æ“ä½œå¤±æ•—:', e);
                showToast('âŒ å„²å­˜å¤±æ•—ï¼š' + e.message, true);
                return;
            }

            hideApiKeyModal();
            updateApiKeyStatus();
            showToast('âœ“ API Key å·²å„²å­˜ï¼');
        }

        function updateApiKeyStatus() {
            const statusDiv = document.getElementById('api-key-status');
            if (!statusDiv) return;

            if (apiKey && apiKey.trim() !== "") {
                const maskedKey = apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4);
                statusDiv.innerHTML = `
                    <div class="flex items-center justify-between bg-emerald-500/10 border border-emerald-500/30 rounded-2xl p-4">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">âœ“</span>
                            <div>
                                <p class="font-bold text-emerald-400">API Key å·²è¨­å®š</p>
                                <p class="text-xs text-slate-300 font-mono">${maskedKey}</p>
                            </div>
                        </div>
                        <button onclick="showApiKeyModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-xl text-sm font-bold transition">
                            æ›´æ”¹
                        </button>
                    </div>
                `;
                statusDiv.classList.remove('hidden');
            } else {
                statusDiv.innerHTML = `
                    <div class="flex items-center justify-between bg-amber-500/10 border border-amber-500/30 rounded-2xl p-4">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">âš ï¸</span>
                            <div>
                                <p class="font-bold text-amber-400">éœ€è¦è¨­å®š API Key</p>
                                <p class="text-xs text-slate-300">å…è²»ç”³è«‹åªéœ€ 3 æ­¥é©Ÿï¼Œä¸ç”¨ä¿¡ç”¨å¡</p>
                            </div>
                        </div>
                        <button onclick="showApiKeyModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-xl text-sm font-bold transition">
                            ç«‹å³è¨­å®š
                        </button>
                    </div>
                `;
                statusDiv.classList.remove('hidden');
            }
        }

        // API Key ç®¡ç†å…¨åŸŸè®Šæ•¸ï¼ˆäº‹ä»¶ç¶å®šå°‡åœ¨ window.load æ™‚é€²è¡Œï¼‰
        let isKeyVisible = false;

        // å°‡ showApiKeyModal è¨­ç‚ºå…¨åŸŸå‡½æ•¸
        window.showApiKeyModal = showApiKeyModal;

        // èª¿è©¦å·¥å…·ï¼šæª¢æŸ¥ localStorageï¼ˆåœ¨æ§åˆ¶å°è¼¸å…¥ checkApiKey() æŸ¥çœ‹ï¼‰
        window.checkApiKey = function() {
            const stored = localStorage.getItem('gemini_api_key');
            console.log('=== API Key ç‹€æ…‹æª¢æŸ¥ ===');
            console.log('localStorage ä¸­çš„å€¼:', stored);
            console.log('é•·åº¦:', stored ? stored.length : 0);
            console.log('å‰8ç¢¼:', stored ? stored.substring(0, 8) : 'N/A');
            console.log('ç•¶å‰ apiKey è®Šæ•¸:', apiKey);
            console.log('å…©è€…æ˜¯å¦ä¸€è‡´:', stored === apiKey);
            return stored;
        };

        function showToast(msg, isError = false) {
            toast.textContent = msg;
            toast.style.backgroundColor = isError ? '#ef4444' : '#1e293b';
            toast.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 3000);
        }

        const wait = (ms) => new Promise(res => setTimeout(res, ms));

        // PDF.js ç›´æ¥æå–æ–‡å­—è³‡è¨Šï¼ˆæ¯” OCR æ›´æº–ç¢ºï¼‰
        async function extractTextFromPdf(page, scale = 2.0) {
            const viewport = page.getViewport({ scale });
            const textContent = await page.getTextContent();
            const pageWidth = viewport.width;
            const pageHeight = viewport.height;

            const textBlocks = textContent.items
                .map(item => {
                    const [scaleX, skewX] = item.transform;
                    const tx = item.transform[4] * scale;
                    const ty = item.transform[5] * scale;
                    const fontSize = Math.sqrt(scaleX * scaleX + skewX * skewX) * scale;

                    // PDF åº§æ¨™ç³» y è»¸å¾åº•éƒ¨é–‹å§‹ï¼Œéœ€è¦è½‰æ›
                    const x = tx;
                    const y = pageHeight - ty;
                    const height = fontSize * 1.2;

                    // ä¼°ç®—æ–‡å­—å¯¬åº¦ï¼ˆPDF.js å¯èƒ½è¿”å› 0 æˆ– undefinedï¼‰
                    const rawWidth = item.width || 0;
                    const estimatedWidth = fontSize * item.str.length * 0.6;
                    const width = (rawWidth > 0 ? rawWidth : estimatedWidth) * scale;

                    return {
                        text: item.str,
                        x,
                        y: y - height,
                        width,
                        height,
                        fontSize,
                        fontName: item.fontName || ''
                    };
                })
                .filter(block => block.text.trim().length > 0);

            return {
                blocks: mergeTextBlocks(textBlocks, pageWidth, pageHeight),
                pageWidth,
                pageHeight
            };
        }

        // åˆä½µç›¸é„°çš„æ–‡å­—å€å¡Šï¼ˆåŒä¸€è¡Œçš„æ–‡å­—ï¼‰
        function mergeTextBlocks(blocks) {
            const validBlocks = (blocks || []).filter(b =>
                b && b.text && b.text.trim() && isFinite(b.x) && isFinite(b.y)
            );
            if (validBlocks.length === 0) return [];

            const avgFontSize = validBlocks.reduce((sum, b) => sum + (b.fontSize || 12), 0) / validBlocks.length;

            function getFontSize(block) {
                return block.fontSize || avgFontSize;
            }

            function estimateWidth(block) {
                return block.width || getFontSize(block) * block.text.length * 0.6;
            }

            // æ­¥é©Ÿ 1: æŒ‰ y åº§æ¨™åˆ†çµ„ï¼ˆä½¿ç”¨å­—é«”å¤§å°çš„ 80% ä½œç‚ºå®¹å·®ï¼‰
            const lines = [];
            const sortedBlocks = [...validBlocks].sort((a, b) => a.y - b.y);

            for (const block of sortedBlocks) {
                let bestLine = null;
                let minDiff = Infinity;

                for (const line of lines) {
                    const lineAvgY = line.items.reduce((sum, item) => sum + item.y, 0) / line.items.length;
                    const lineFontSize = line.items.reduce((sum, item) => sum + getFontSize(item), 0) / line.items.length;
                    const tolerance = Math.max(lineFontSize, getFontSize(block)) * 0.8;
                    const diff = Math.abs(lineAvgY - block.y);

                    if (diff < tolerance && diff < minDiff) {
                        minDiff = diff;
                        bestLine = line;
                    }
                }

                if (bestLine) {
                    bestLine.items.push(block);
                } else {
                    lines.push({ items: [block] });
                }
            }

            // æ­¥é©Ÿ 2: æ¯è¡Œå…§æŒ‰ x åº§æ¨™æ’åºä¸¦åˆä½µç›¸é„°æ–‡å­—
            const merged = [];

            for (const line of lines) {
                line.items.sort((a, b) => a.x - b.x);
                const lineAvgY = line.items.reduce((sum, item) => sum + item.y, 0) / line.items.length;

                let current = null;

                for (const item of line.items) {
                    const itemWidth = estimateWidth(item);

                    if (!current) {
                        current = { ...item, width: itemWidth };
                        continue;
                    }

                    const currentWidth = current.width || avgFontSize;
                    const gap = item.x - (current.x + currentWidth);
                    const gapTolerance = Math.max(getFontSize(current), getFontSize(item)) * 1.5;

                    if (Math.abs(gap) < gapTolerance) {
                        // åˆä½µæ–‡å­—
                        current.text += item.text;
                        current.width = Math.max((item.x + itemWidth) - current.x, currentWidth);
                        current.height = Math.max(current.height || 0, item.height || 0);
                        current.fontSize = Math.max(current.fontSize || 0, item.fontSize || 0);
                    } else {
                        // é–“è·å¤ªå¤§ï¼Œè¦–ç‚ºæ–°å€å¡Š
                        merged.push(current);
                        current = { ...item, width: itemWidth };
                    }
                }

                if (current) {
                    current.y = lineAvgY;
                    merged.push(current);
                }
            }

            return merged.sort((a, b) => a.y - b.y);
        }

        // 429 éŒ¯èª¤è¨ˆæ•¸å™¨
        let rateLimitCount = 0;

        async function fetchWithRetry(url, options, maxRetries = 5) {
            const delays = [2000, 4000, 8000, 16000, 32000];
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    const text = await response.text();

                    // å˜—è©¦è§£æ JSON
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        // JSON è§£æå¤±æ•—ï¼Œæ ¹æ“šå›æ‡‰å…§å®¹åˆ¤æ–·éŒ¯èª¤é¡å‹
                        const preview = text.substring(0, 200);
                        console.error(`JSON è§£æå¤±æ•—ï¼Œå›æ‡‰å…§å®¹: ${preview}`);
                        // æª¢æŸ¥æ˜¯å¦ç‚º API é‡‘é‘°ç›¸é—œéŒ¯èª¤
                        if (text.includes('API key not valid') || text.includes('API_KEY_INVALID')) {
                            throw new Error('API é‡‘é‘°ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥æ‚¨çš„ Gemini API é‡‘é‘°');
                        }
                        if (text.includes('PERMISSION_DENIED') || text.includes('authenticate')) {
                            throw new Error('API é©—è­‰å¤±æ•—ï¼Œè«‹ç¢ºèª API é‡‘é‘°æˆ–åŸ·è¡Œç’°å¢ƒ');
                        }
                        throw new Error(`API å›æ‡‰æ ¼å¼éŒ¯èª¤: ${preview}...`);
                    }

                    if (response.ok) return data;

                    if (response.status === 429) {
                        rateLimitCount++;
                        const waitTime = delays[i] || 10000;
                        showToast(`API é »ç‡é™åˆ¶ (429)ï¼Œç¬¬ ${rateLimitCount} æ¬¡ï¼Œç­‰å¾… ${waitTime/1000} ç§’...`, true);
                        await wait(waitTime);
                        continue;
                    }

                    throw new Error(data.error?.message || `HTTP ${response.status}`);
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                    await wait(2000);
                }
            }
        }

        // æ‹–æ”¾äº‹ä»¶
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => handleFiles(e.target.files);
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drop-zone-active'); };
        dropZone.ondragleave = () => dropZone.classList.remove('drop-zone-active');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone-active');
            handleFiles(e.dataTransfer.files);
        };

        // æ­¥é©Ÿ 1: è®€å–æª”æ¡ˆä¸¦ç”Ÿæˆç¸®åœ–
        async function handleFiles(files) {
            if (!initPdfLibrary()) return;
            if (!files || files.length === 0) return;

            // é¡¯ç¤ºè®€å–ä¸­ç‹€æ…‹
            dropZone.innerHTML = `<div class="loader mx-auto mb-4"></div><p class="text-slate-300">æ­£åœ¨è®€å–ä¸¦å»ºç«‹ç¸®åœ–...</p>`;
            dropZone.style.pointerEvents = 'none';

            pendingItems = []; // é‡ç½®å¾…è™•ç†æ¸…å–®

            try {
                for (let file of files) {
                    const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                    const isImage = file.type.startsWith('image/') || /\.(jpg|jpeg|png|webp|bmp)$/i.test(file.name);

                    if (isPdf) {
                        await loadPdfAndGenerateThumbs(file);
                    } else if (isImage) {
                        const base64 = await fileToBase64(file);
                        pendingItems.push({
                            id: `img_${Date.now()}_${Math.random()}`,
                            type: 'image',
                            name: file.name,
                            thumb: base64, // åœ–ç‰‡ç›´æ¥ç”¨åŸåœ–ç•¶ç¸®åœ–
                            original: base64,
                            selected: true // é è¨­é¸ä¸­
                        });
                    }
                }

                if (pendingItems.length > 0) {
                    renderSelectionGrid();
                } else {
                    showToast('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼', true);
                    location.reload();
                }
            } catch (err) {
                console.error(err);
                showToast(err.message || 'æª”æ¡ˆè®€å–å¤±æ•—', true);
                setTimeout(() => location.reload(), 2000);
            }
        }

        // è®€å– PDF ä¸¦ç”¢ç”Ÿä½è§£æç¸®åœ–
        async function loadPdfAndGenerateThumbs(file) {
            const arrayBuffer = await file.arrayBuffer();
            const lib = window.pdfjsLib;

            const pdfDoc = await lib.getDocument({
                data: arrayBuffer,
                cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                cMapPacked: true
            }).promise;

            const total = pdfDoc.numPages;

            for (let i = 1; i <= total; i++) {
                const page = await pdfDoc.getPage(i);
                // ä½¿ç”¨ä½ Scale (0.5) å¿«é€Ÿç”Ÿæˆç¸®åœ–
                const viewport = page.getViewport({ scale: 0.5 });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: ctx, viewport }).promise;

                pendingItems.push({
                    id: `pdf_${file.name}_${i}`,
                    type: 'pdf',
                    name: `${file.name} - P${i}`,
                    thumb: canvas.toDataURL('image/jpeg', 0.6).split(',')[1],
                    pdfDoc: pdfDoc, // ä¿å­˜æ–‡æª”å¼•ç”¨ä»¥ä¾¿ç¨å¾Œé«˜æ¸…æ¸²æŸ“
                    pageNum: i,
                    selected: true // é è¨­é¸ä¸­
                });
            }
        }

        // æ­¥é©Ÿ 2: æ¸²æŸ“é¸æ“‡ä»‹é¢
        function renderSelectionGrid() {
            uploadSection.classList.add('hidden');
            selectionSection.classList.remove('hidden');
            selectionGrid.innerHTML = '';

            pendingItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'relative group';
                div.innerHTML = `
                    <label class="cursor-pointer block relative">
                        <input type="checkbox" class="custom-checkbox hidden" ${item.selected ? 'checked' : ''} onchange="toggleSelection(${index}, this.checked)">
                        <div class="glass rounded-xl overflow-hidden border-2 border-transparent transition-all h-32 md:h-40 flex flex-col relative">
                            <img src="data:image/jpeg;base64,${item.thumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">

                            <!-- å‹¾é¸ç‹€æ…‹é®ç½© -->
                            <div class="check-icon absolute top-2 right-2 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg transform scale-0 transition-transform duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
                            </div>

                            <div class="absolute bottom-0 left-0 right-0 bg-black/60 p-1 text-[10px] text-center truncate text-white backdrop-blur-sm">
                                ${item.name}
                            </div>
                        </div>
                    </label>
                `;
                selectionGrid.appendChild(div);
            });
            updateSelectedCount();
        }

        window.toggleSelection = (index, isChecked) => {
            pendingItems[index].selected = isChecked;
            updateSelectedCount();
        };

        function updateSelectedCount() {
            const count = pendingItems.filter(i => i.selected).length;
            selectedCountSpan.textContent = count;
            document.getElementById('start-process-btn').disabled = count === 0;
            document.getElementById('start-process-btn').classList.toggle('opacity-50', count === 0);
        }

        // å…¨é¸/å…¨å–æ¶ˆ
        document.getElementById('select-all-btn').onclick = () => {
            pendingItems.forEach(i => i.selected = true);
            renderSelectionGrid();
        };
        document.getElementById('deselect-all-btn').onclick = () => {
            pendingItems.forEach(i => i.selected = false);
            renderSelectionGrid();
        };

        // æ­¥é©Ÿ 3: é–‹å§‹è™•ç†é¸ä¸­çš„é …ç›®
        document.getElementById('start-process-btn').onclick = async () => {
            const selectedItems = pendingItems.filter(i => i.selected);
            if (selectedItems.length === 0) return;

            selectionSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');

            // é–‹å§‹è™•ç†æµç¨‹
            await processSelectedItems(selectedItems);
        };

        async function processSelectedItems(items) {
            // æª¢æŸ¥ API Key
            if (!apiKey || apiKey.trim() === "") {
                showToast("âŒ è«‹å…ˆè¨­å®š API Key", true);
                progressSection.classList.add('hidden');
                selectionSection.classList.remove('hidden');
                showApiKeyModal();
                return;
            }

            results = [];
            resultsGrid.innerHTML = '';
            resultsSection.classList.remove('hidden');
            rateLimitCount = 0; // é‡ç½® 429 è¨ˆæ•¸å™¨

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                let processBase64 = item.thumb; // é è¨­

                progressTitle.textContent = `è™•ç†ä¸­: ${item.name}`;
                progressCount.textContent = `${i + 1}/${items.length}`;
                progressBar.style.width = `${((i + 1) / items.length) * 100}%`;

                // å¦‚æœæ˜¯ PDFï¼Œé€™è£¡æ‰é€²è¡Œé«˜æ¸…æ¸²æŸ“ (Scale 2.0) ä¸¦æå–åŸå§‹æ–‡å­—
                let pdfTextData = null;
                if (item.type === 'pdf') {
                    progressDetail.textContent = "æ­£åœ¨ç”Ÿæˆé«˜è§£æå½±åƒ...";
                    try {
                        const page = await item.pdfDoc.getPage(item.pageNum);
                        const viewport = page.getViewport({ scale: 2.0 }); // é«˜è§£æåº¦
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: ctx, viewport }).promise;
                        processBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

                        // æå– PDF åŸå§‹æ–‡å­—è³‡è¨Šï¼ˆæ¯” OCR æ›´æº–ç¢ºï¼‰
                        progressDetail.textContent = "æ­£åœ¨æå–åŸå§‹æ–‡å­—åº§æ¨™...";
                        pdfTextData = await extractTextFromPdf(page, 2.0);
                    } catch (e) {
                        console.error("Re-render error", e);
                        // è‹¥å¤±æ•—å‰‡é™ç´šä½¿ç”¨ç¸®åœ–
                    }
                } else {
                    processBase64 = item.original;
                }

                // æ±ºå®šæ˜¯å¦éœ€è¦ OCRï¼ˆPDF æ²’æœ‰æ–‡å­—åœ–å±¤æ™‚ä¹Ÿéœ€è¦ï¼‰
                const needsOcr = item.type !== 'pdf' || !pdfTextData || pdfTextData.blocks.length === 0;

                // çµ±ä¸€è™•ç†ï¼šå¹³è¡Œèª¿ç”¨æ–‡å­—ç§»é™¤èˆ‡ OCRï¼ˆå¦‚éœ€è¦ï¼‰
                progressDetail.textContent = needsOcr
                    ? "AI æ­£åœ¨ç§»é™¤æ–‡å­—ä¸¦åŒæ­¥è¾¨è­˜å…§å®¹..."
                    : "AI æ­£åœ¨ç§»é™¤æ–‡å­—ä¸¦é‡å»ºèƒŒæ™¯...";

                try {
                    // æº–å‚™ OCR ç”¨çš„åœ–ç‰‡ï¼ˆPDF ç”¨é«˜æ¸…æ¸²æŸ“åœ–ï¼Œåœ–ç‰‡ç”¨åŸåœ–ï¼‰
                    const ocrBase64 = item.type === 'pdf' ? processBase64 : item.original;

                    const [cleanedResult, ocrResult] = await Promise.allSettled([
                        removeTextWithGemini(processBase64),
                        needsOcr ? ocrWithGemini(ocrBase64) : Promise.resolve([])
                    ]);

                    const cleaned = cleanedResult.status === 'fulfilled' ? cleanedResult.value : null;
                    const ocrBlocks = ocrResult.status === 'fulfilled' ? ocrResult.value : [];

                    if (cleanedResult.status === 'rejected') {
                        console.error("æ–‡å­—ç§»é™¤å¤±æ•—:", cleanedResult.reason);
                    }
                    if (ocrResult.status === 'rejected') {
                        console.warn("OCR å¤±æ•—ï¼ŒåŒ¯å‡ºæ™‚å°‡è·³éæ–‡å­—å±¤:", ocrResult.reason);
                    }

                    // æ±ºå®šæ–‡å­—ä¾†æºï¼šå„ªå…ˆä½¿ç”¨ pdfTextDataï¼Œå¦å‰‡ä½¿ç”¨ ocrBlocks
                    const finalPdfTextData = (pdfTextData?.blocks?.length > 0) ? pdfTextData : null;
                    const finalOcrBlocks = finalPdfTextData ? null : ocrBlocks;

                    if (cleaned) {
                        results.push({
                            name: item.name,
                            original: processBase64,
                            cleaned,
                            sourceType: item.type,
                            pdfTextData: finalPdfTextData,
                            ocrBlocks: finalOcrBlocks
                        });
                        addResultCard(i, item.name, cleaned);
                    } else {
                        const isAuthError = cleanedResult.reason?.message?.includes("400") ||
                                           cleanedResult.reason?.message?.includes("403") ||
                                           cleanedResult.reason?.message?.includes("key");
                        const errMsg = isAuthError ? "API Key ç„¡æ•ˆæˆ–ç’°å¢ƒç•°å¸¸" : (cleanedResult.reason?.message || "è™•ç†å¤±æ•—");
                        results.push({
                            name: item.name,
                            original: processBase64,
                            cleaned: null,
                            error: errMsg,
                            sourceType: item.type,
                            pdfTextData: finalPdfTextData,
                            ocrBlocks: finalOcrBlocks
                        });
                        addResultCard(i, item.name, null, errMsg);
                    }
                } catch (e) {
                    console.error(e);
                    results.push({
                        name: item.name,
                        original: processBase64,
                        cleaned: null,
                        error: e.message,
                        sourceType: item.type,
                        pdfTextData: null,
                        ocrBlocks: []
                    });
                    addResultCard(i, item.name, null, e.message);
                }

                // ä¸¦è¡Œè™•ç†å·²æ¸›å°‘ç¸½æ™‚é–“ï¼Œ1 ç§’é–“éš”è¶³å¤ é¿å…é »ç‡é™åˆ¶
                if (i < items.length - 1) await wait(1000);
            }

            // é¡¯ç¤ºè™•ç†å®Œæˆæ‘˜è¦
            const successCount = results.filter(r => r.cleaned).length;
            const failCount = results.filter(r => !r.cleaned).length;
            let summary = `è™•ç†å®Œæˆï¼š${successCount} æˆåŠŸ`;
            if (failCount > 0) summary += `ï¼Œ${failCount} å¤±æ•—`;
            if (rateLimitCount > 0) summary += `ï¼ˆé­é‡ ${rateLimitCount} æ¬¡é »ç‡é™åˆ¶ï¼‰`;
            showToast(summary, failCount > 0 || rateLimitCount > 3);

            setTimeout(() => progressSection.classList.add('hidden'), 1000);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function removeTextWithGemini(base64) {
            const baseUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE_EDIT}:generateContent`;
            const url = apiKey ? `${baseUrl}?key=${apiKey}` : baseUrl;
            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: "Edit this image by removing all visible text and numbers while preserving the original background patterns, colors, and design elements. Use content-aware fill to seamlessly reconstruct the areas where text was removed. Return the edited image." },
                        { inlineData: { mimeType: "image/png", data: base64 } }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE'],
                    temperature: 0.4
                }
            };

            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // æª¢æŸ¥æ˜¯å¦é‡åˆ°ç‰ˆæ¬Šé™åˆ¶
            const finishReason = data.candidates?.[0]?.finishReason;
            if (finishReason === 'IMAGE_RECITATION') {
                console.error("IMAGE_RECITATION éŒ¯èª¤:", data.candidates?.[0]?.finishMessage);
                throw new Error("åœ–ç‰‡è™•ç†å—é™ï¼šGemini æª¢æ¸¬åˆ°å¯èƒ½çš„ç‰ˆæ¬Šå•é¡Œã€‚è«‹å˜—è©¦ä½¿ç”¨ä¸åŒçš„åœ–ç‰‡æˆ–èª¿æ•´å…§å®¹ã€‚");
            }

            const part = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
            if (!part) {
                // æª¢æŸ¥æ˜¯å¦è¿”å›äº†æ–‡å­—è€Œéåœ–åƒ
                const textPart = data.candidates?.[0]?.content?.parts?.find(p => p.text);
                if (textPart) {
                    console.warn("API è¿”å›æ–‡å­—è€Œéåœ–åƒ:", textPart.text);
                    throw new Error("AI è¿”å›æ–‡å­—å›æ‡‰è€Œéåœ–åƒï¼Œè«‹é‡è©¦");
                }
                console.error("API å›æ‡‰çµæ§‹:", JSON.stringify(data, null, 2));
                throw new Error(data.error?.message || "API æœªè¿”å›å½±åƒæ•¸æ“š");
            }
            return part.inlineData.data;
        }

        async function ocrWithGemini(base64) {
            const baseUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT_GEN}:generateContent`;
            const url = apiKey ? `${baseUrl}?key=${apiKey}` : baseUrl;
            const payload = {
                contents: [{
                    parts: [
                        {
                            text: `Analyze this image and extract all text blocks with precise positioning and styling.
For each text block, provide:
- text: the exact text content
- box_2d: bounding box as [ymin, xmin, ymax, xmax] in 0-1000 coordinate system
- font_size_pt: estimated font size in points (typical range: 8-72)
- font_weight: "normal" or "bold"
- font_style: "normal" or "italic"
- text_align: "left", "center", or "right" (based on text position in its container)
- color: hex color code like "000000" or "FFFFFF"
- line_height: line height multiplier (typically 1.0-2.0)

Return as JSON array. Be precise with bounding boxes.`
                        },
                        { inlineData: { mimeType: "image/png", data: base64 } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                text: { type: "STRING" },
                                box_2d: { type: "ARRAY", items: { type: "NUMBER" }, minItems: 4, maxItems: 4 },
                                font_size_pt: { type: "NUMBER" },
                                font_weight: { type: "STRING" },
                                font_style: { type: "STRING" },
                                text_align: { type: "STRING" },
                                color: { type: "STRING" },
                                line_height: { type: "NUMBER" }
                            }
                        }
                    }
                }
            };

            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                throw new Error("OCR è¾¨è­˜å¤±æ•—æˆ–ç„¡æ–‡å­—å…§å®¹");
            }

            const ocrText = data.candidates[0].content.parts[0].text;
            try {
                return JSON.parse(ocrText);
            } catch (parseError) {
                console.error('OCR JSON è§£æå¤±æ•—:', ocrText.substring(0, 500));
                // å˜—è©¦è¿”å›ç©ºé™£åˆ—ï¼Œè®“è™•ç†ç¹¼çºŒï¼ˆåƒ…æœ‰èƒŒæ™¯åœ–ï¼Œç„¡æ–‡å­—å±¤ï¼‰
                console.warn('ç„¡æ³•è§£æ OCR çµæœï¼Œå°‡åƒ…ä¿ç•™èƒŒæ™¯åœ–');
                return [];
            }
        }

        function addResultCard(index, name, cleaned, error) {
            const div = document.createElement('div');
            div.className = 'result-card glass rounded-2xl overflow-hidden';
            if (cleaned) {
                div.innerHTML = `
                    <img src="data:image/png;base64,${cleaned}" class="w-full aspect-video object-cover">
                    <div class="p-4 flex justify-between items-center text-[10px]">
                        <span class="truncate max-w-[80%]">${name}</span>
                        <span class="text-emerald-400 font-bold">æˆåŠŸ</span>
                    </div>
                `;
            } else {
                div.innerHTML = `<div class="p-6 text-center text-red-400 text-[10px]">${error || 'å¤±æ•—'}</div>`;
            }
            resultsGrid.appendChild(div);
        }

        document.getElementById('export-combined-btn').onclick = async () => {
            const valid = results.filter(r => r.cleaned);
            if (!valid.length) return;

            const btn = document.getElementById('export-combined-btn');
            btn.disabled = true;
            btn.innerHTML = "æ­£åœ¨è™•ç†æ–‡å­—...";

            try {
                const pptx = new PptxGenJS();
                const ratio = document.getElementById('ratio-select').value;
                pptx.layout = ratio === '16:9' ? 'LAYOUT_WIDE' : ratio === '4:3' ? 'LAYOUT_4x3' : 'LAYOUT_WIDE';

                // å–å¾—ç°¡å ±å¯¦éš›å°ºå¯¸ï¼ˆè‹±å‹ï¼‰
                const slideWidth = ratio === '16:9' ? 13.333 : ratio === '4:3' ? 10 : 13.333;
                const slideHeight = ratio === '16:9' ? 7.5 : ratio === '4:3' ? 7.5 : 7.5;

                for (let i = 0; i < valid.length; i++) {
                    const r = valid[i];
                    const slide = pptx.addSlide();
                    slide.addImage({ data: `data:image/png;base64,${r.cleaned}`, x: 0, y: 0, w: '100%', h: '100%' });

                    try {
                        // æ ¹æ“šä¾†æºé¡å‹é¸æ“‡æ–‡å­—æå–æ–¹å¼
                        if (r.sourceType === 'pdf' && r.pdfTextData && r.pdfTextData.blocks.length > 0) {
                            // PDF ä¾†æºï¼šä½¿ç”¨å·²æå–çš„ç²¾ç¢ºæ–‡å­—è³‡è¨Šï¼ˆç„¡éœ€ API èª¿ç”¨ï¼‰
                            showToast(`ä½¿ç”¨ PDF åŸå§‹æ–‡å­— (${i+1}/${valid.length})...`);

                            const { blocks, pageWidth, pageHeight } = r.pdfTextData;
                            blocks.forEach(block => {
                                if (!block.text.trim()) return;

                                // å°‡åƒç´ åº§æ¨™è½‰æ›ç‚ºç°¡å ±ç™¾åˆ†æ¯”åº§æ¨™
                                const xPercent = (block.x / pageWidth) * 100;
                                const yPercent = (block.y / pageHeight) * 100;
                                const wPercent = (block.width / pageWidth) * 100;
                                const hPercent = (block.height / pageHeight) * 100;

                                // æ ¹æ“šç°¡å ±å°ºå¯¸è¨ˆç®—å­—é«”å¤§å°ï¼ˆptï¼‰
                                // PDF å­—é«”å¤§å°æ˜¯ç›¸å°æ–¼ 2.0 scaleï¼Œéœ€è¦è½‰æ›ç‚ºç°¡å ±å¯¦éš›å¤§å°
                                const scaleFactor = (slideHeight * 72) / pageHeight; // 72 pt per inch
                                const fontSize = Math.max(6, Math.min(72, block.fontSize * scaleFactor * 0.8));

                                slide.addText(block.text, {
                                    x: `${xPercent}%`,
                                    y: `${yPercent}%`,
                                    w: `${Math.max(wPercent, 5)}%`,
                                    h: `${Math.max(hPercent, 2)}%`,
                                    fontSize: Math.round(fontSize),
                                    color: '000000',
                                    fontFace: 'Microsoft JhengHei',
                                    valign: 'top'
                                });
                            });
                        } else if (r.ocrBlocks && r.ocrBlocks.length > 0) {
                            // ä½¿ç”¨é å…ˆå–å¾—çš„ OCR çµæœ
                            showToast(`å¥—ç”¨æ–‡å­—å±¤ (${i+1}/${valid.length})...`);

                            r.ocrBlocks.forEach(b => {
                                if (!b.text || !b.text.trim()) return;
                                if (!b.box_2d || b.box_2d.length !== 4) return;

                                const [ymin, xmin, ymax, xmax] = b.box_2d;

                                // æ§‹å»ºæ–‡å­—æ¨£å¼
                                const textOptions = {
                                    x: `${xmin/10}%`,
                                    y: `${ymin/10}%`,
                                    w: `${Math.max((xmax-xmin)/10, 5)}%`,
                                    h: `${Math.max((ymax-ymin)/10, 2)}%`,
                                    fontSize: b.font_size_pt || 14,
                                    color: (b.color || "000000").replace("#", ""),
                                    fontFace: 'Microsoft JhengHei',
                                    valign: 'top'
                                };

                                // å¥—ç”¨å­—é‡
                                if (b.font_weight === 'bold') {
                                    textOptions.bold = true;
                                }

                                // å¥—ç”¨æ–œé«”
                                if (b.font_style === 'italic') {
                                    textOptions.italic = true;
                                }

                                // å¥—ç”¨å°é½Š
                                if (b.text_align) {
                                    textOptions.align = b.text_align;
                                }

                                slide.addText(b.text, textOptions);
                            });
                        } else {
                            // ç„¡ OCR è³‡æ–™ï¼Œè·³éæ–‡å­—å±¤
                            console.warn(`ç¬¬ ${i+1} é ç„¡ OCR è³‡æ–™ï¼Œåƒ…åŒ¯å‡ºèƒŒæ™¯åœ–`);
                        }
                    } catch (e) {
                        console.warn("Text extraction failed for slide", i, e);
                    }
                }
                pptx.writeFile({ fileName: `Result_${Date.now()}.pptx` });
                showToast('å°å‡ºæˆåŠŸ');
            } catch (e) {
                console.error("Export error", e);
                showToast("å°å‡ºå¤±æ•—: " + e.message, true);
            }
            btn.disabled = false;
            btn.innerHTML = "åˆä½µ PPTX â­";
        };

        // è»Ÿé‡ç½®ï¼šæ¸…ç©ºç‹€æ…‹ä¸¦å›åˆ°åˆå§‹ä»‹é¢ï¼ˆä¿ç•™ API Keyï¼‰
        function softReset() {
            console.log('=== åŸ·è¡Œè»Ÿé‡ç½® ===');
            console.log('ä¿ç•™ API Key:', apiKey.substring(0, 8) + '...');

            // é‡ç½®ç‹€æ…‹è®Šæ•¸
            pendingItems = [];
            results = [];
            rateLimitCount = 0;

            // é‡ç½® UI - éš±è—æ‰€æœ‰å€å¡Š
            selectionSection.classList.add('hidden');
            progressSection.classList.add('hidden');
            resultsSection.classList.add('hidden');

            // é¡¯ç¤ºä¸Šå‚³å€
            uploadSection.classList.remove('hidden');

            // æ¸…ç©ºå…§å®¹
            selectionGrid.innerHTML = '';
            resultsGrid.innerHTML = '';

            // é‡ç½®é€²åº¦æ¢
            progressBar.style.width = '0%';
            progressTitle.textContent = '';
            progressDetail.textContent = '';
            progressCount.textContent = '';

            // æ¸…ç©ºæª”æ¡ˆè¼¸å…¥ï¼ˆæš«æ™‚ç§»é™¤äº‹ä»¶ç›£è½å™¨ä»¥é¿å…è§¸ç™¼ change äº‹ä»¶ï¼‰
            fileInput.onchange = null;
            fileInput.value = '';
            fileInput.onchange = e => handleFiles(e.target.files);

            // é‡ç½®ä¸Šå‚³å€åŸŸçš„ HTMLï¼ˆæ¢å¾©åˆå§‹ç‹€æ…‹ï¼‰
            dropZone.innerHTML = `
                <input type="file" id="file-input" class="hidden" accept="application/pdf,image/*" multiple>
                <div class="w-20 h-20 bg-blue-500/20 text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <p class="text-2xl font-bold text-white mb-2">æ‹–æ”¾ PDF æˆ–åœ–ç‰‡</p>
                <p class="text-slate-400">é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆ</p>
                <div id="lib-warning" class="mt-4 text-xs text-amber-400 hidden">è­¦å‘Šï¼šçµ„ä»¶å°šæœªå°±ç·’ï¼Œè«‹ç¨å€™...</div>
            `;
            dropZone.style.pointerEvents = 'auto';

            // é‡ç½®é¸æ“‡è¨ˆæ•¸
            selectedCountSpan.textContent = '0';

            console.log('âœ“ è»Ÿé‡ç½®å®Œæˆï¼ŒAPI Key ä¿ç•™');
            showToast('âœ“ å·²é‡ç½®ï¼Œå¯ä»¥é–‹å§‹æ–°çš„è™•ç†');
        }

        document.getElementById('reset-btn').onclick = softReset;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('load', () => {
            // åˆå§‹åŒ– PDF å‡½å¼åº«
            initPdfLibrary();

            // åˆå§‹åŒ– API Key äº‹ä»¶ç¶å®š
            initApiKeyEvents();

            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            updateApiKeyStatus();

            // å¦‚æœæ²’æœ‰ API Keyï¼Œé¡¯ç¤ºè¨­å®šè¦–çª—
            if (!apiKey || apiKey.trim() === "") {
                setTimeout(() => showApiKeyModal(), 500);
            }
        });

        // åˆå§‹åŒ–æ‰€æœ‰ API Key ç›¸é—œäº‹ä»¶
        function initApiKeyEvents() {
            // é‡æ–°å–å¾—æ‰€æœ‰å…ƒç´ ï¼ˆç¢ºä¿ DOM å·²è¼‰å…¥ï¼‰
            const toggleBtn = document.getElementById('toggle-visibility');
            const closeBtn = document.getElementById('close-modal');
            const saveBtn = document.getElementById('save-api-key');
            const keyInput = document.getElementById('api-key-input');
            const keyModal = document.getElementById('api-key-modal');

            // åˆ‡æ› API Key å¯è¦‹æ€§
            if (toggleBtn && keyInput) {
                toggleBtn.onclick = () => {
                    isKeyVisible = !isKeyVisible;
                    keyInput.type = isKeyVisible ? 'text' : 'password';
                    toggleBtn.textContent = isKeyVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
                };
            }

            // æ¨¡æ…‹è¦–çª—é—œé–‰æŒ‰éˆ•
            if (closeBtn) {
                closeBtn.onclick = () => {
                    if (!apiKey || apiKey.trim() === "") {
                        if (!confirm('å°šæœªè¨­å®š API Keyï¼Œéƒ¨åˆ†åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ã€‚ç¢ºå®šè¦é—œé–‰å—ï¼Ÿ')) {
                            return;
                        }
                    }
                    hideApiKeyModal();
                };
            }

            // å„²å­˜æŒ‰éˆ•
            if (saveBtn) {
                saveBtn.onclick = saveApiKey;
            }

            // ESC éµé—œé–‰æ¨¡æ…‹è¦–çª—
            if (keyModal) {
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !keyModal.classList.contains('hidden')) {
                        hideApiKeyModal();
                    }
                });
            }

            // ç›£è½æ‰‹å‹•è²¼ä¸Šäº‹ä»¶ï¼ˆé©—è­‰æ ¼å¼ï¼‰
            if (keyInput) {
                keyInput.addEventListener('paste', (e) => {
                    setTimeout(() => {
                        const value = keyInput.value.trim();
                        if (value.startsWith('AIza')) {
                            showToast('âœ“ API Key æ ¼å¼æ­£ç¢º', false);
                        } else if (value) {
                            showToast('âš ï¸ è«‹ç¢ºèª API Key æ ¼å¼ï¼ˆæ‡‰ä»¥ AIza é–‹é ­ï¼‰', true);
                        }
                    }, 100);
                });

                // Enter éµå„²å­˜
                keyInput.onkeypress = (e) => {
                    if (e.key === 'Enter') saveApiKey();
                };
            }
        }
    </script>
</body>
</html>
