<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NotebookLM to PPTX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;600;700&display=swap');

        :root {
            --color-primary: #3B82F6;
            --color-primary-dark: #2563EB;
            --color-primary-light: #60A5FA;
            --color-cta: #F97316;
            --color-cta-hover: #EA580C;
            --color-text: #1E293B;
            --color-text-light: #64748B;
            --color-bg: #F8FAFC;
            --color-surface: #FFFFFF;
            --color-border: #E2E8F0;
            --color-success: #10B981;
            --color-warning: #F59E0B;
            --color-danger: #EF4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Open Sans', 'Noto Sans JP', sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            position: relative;
            min-height: 100vh;
        }

        /* Subtle grain texture */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.02;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' /%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', 'Noto Sans JP', sans-serif;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 1rem;
            position: relative;
            z-index: 1;
        }

        @media (min-width: 768px) {
            .container {
                padding: 0 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .container {
                padding: 0 2rem;
            }
        }

        /* Header */
        header {
            padding: 3rem 0 2rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-size: 1.125rem;
            color: var(--color-text-light);
            margin-bottom: 1rem;
        }

        .version-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 1rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 2rem;
            font-size: 0.75rem;
            color: var(--color-text-light);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .version-number {
            color: var(--color-primary);
            font-weight: 700;
        }

        /* Alert Banner */
        .alert-banner {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.08), rgba(245, 158, 11, 0.08));
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 0.75rem;
            padding: 1rem 1.25rem;
            margin: 1.5rem auto;
            max-width: 700px;
        }

        .alert-banner-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            user-select: none;
        }

        .alert-banner-header svg {
            flex-shrink: 0;
            transition: transform 0.2s ease;
        }

        .alert-banner-header.expanded svg {
            transform: rotate(180deg);
        }

        .alert-banner-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .alert-banner-content.expanded {
            max-height: 500px;
            margin-top: 1rem;
        }

        /* Cards */
        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
            transition: box-shadow 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--color-border);
            border-radius: 1rem;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
            background: var(--color-surface);
        }

        .upload-zone:hover {
            border-color: var(--color-primary);
            background: rgba(59, 130, 246, 0.02);
        }

        .upload-zone.dragover {
            border-color: var(--color-primary);
            background: rgba(59, 130, 246, 0.05);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
        }

        .btn:hover {
            background: var(--color-primary-dark);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .btn-secondary:hover {
            background: var(--color-bg);
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .btn-cta {
            background: var(--color-cta);
            box-shadow: 0 1px 3px rgba(249, 115, 22, 0.3);
        }

        .btn-cta:hover {
            background: var(--color-cta-hover);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
        }

        /* Collapsible Tools */
        .collapsible-trigger {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            color: var(--color-text-light);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .collapsible-trigger:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .collapsible-trigger svg {
            transition: transform 0.2s ease;
        }

        .collapsible-trigger.active svg {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.active {
            max-height: 500px;
        }

        /* Tool Cards */
        .tool-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .tool-card {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1.5rem;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            text-decoration: none;
            color: inherit;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tool-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .tool-card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .tool-card h3 {
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .tool-card p {
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin: 0;
        }

        .external-icon {
            margin-left: auto;
            opacity: 0.4;
            transition: opacity 0.2s ease;
        }

        .tool-card:hover .external-icon {
            opacity: 1;
        }

        /* Checkbox */
        .checkbox-wrapper {
            position: relative;
            cursor: pointer;
        }

        .checkbox-wrapper input {
            position: absolute;
            opacity: 0;
        }

        .checkbox-custom {
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--color-border);
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .checkbox-wrapper input:checked + .checkbox-custom {
            background: var(--color-primary);
            border-color: var(--color-primary);
        }

        .checkbox-wrapper input:checked + .checkbox-custom svg {
            opacity: 1;
        }

        .checkbox-custom svg {
            opacity: 0;
            color: white;
            width: 0.75rem;
            height: 0.75rem;
        }

        /* Thumbnail Grid */
        .thumbnail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .thumbnail-item {
            position: relative;
            border: 2px solid var(--color-border);
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--color-surface);
        }

        .thumbnail-item:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .thumbnail-item.selected {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Result Cards */
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .result-card {
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: all 0.2s ease;
            background: var(--color-surface);
        }

        .result-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .result-card img {
            width: 100%;
            height: auto;
            display: block;
        }

        .result-card-content {
            padding: 1rem;
        }

        /* Progress */
        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background: var(--color-border);
            border-radius: 0.25rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--color-primary);
            transition: width 0.3s ease;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--color-text);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Utility Classes */
        .hidden { display: none; }
        .text-muted { color: var(--color-text-light); }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-8 { margin-bottom: 2rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .fade-in {
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Icon Styles */
        .icon-warning { color: var(--color-warning); }
        .icon-success { color: var(--color-success); }
        .icon-danger { color: var(--color-danger); }
        .icon-info { color: var(--color-primary); }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>NotebookLM ã‹ã‚‰ PPTX ã¸ <span style="color: var(--color-primary); font-size: 0.6em;">[ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰]</span></h1>
            <p class="subtitle">NotebookLM ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸ PDF ã‚’ç·¨é›†å¯èƒ½ãª PowerPoint ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤‰æ›</p>
            <div class="version-badge" style="background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%); border-color: #3B82F6; color: #1E40AF;">
                <span class="version-number" style="font-weight: 600;">v2.3-dual-mode</span>
                <span style="font-weight: 500;">OCRãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼šLiteï¼ˆé«˜é€Ÿãƒ»å‰²å½“ç¯€ç´„ï¼‰/ æ¨™æº–ï¼ˆå®Œå…¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰</span>
            </div>

            <!-- Collapsible Alert Banner -->
            <div class="alert-banner">
                <div class="alert-banner-header" id="alert-header">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="color: #3B82F6;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <div style="flex: 1;">
                        <p style="font-weight: 600; color: #3B82F6; margin: 0;">âš¡ ãƒ‡ãƒ¥ã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ‰ç‰ˆï¼šOCRãƒ¢ãƒ‡ãƒ«é¸æŠå¯èƒ½ï¼ˆLite é«˜é€Ÿãƒ»å‰²å½“ç¯€ç´„ / æ¨™æº– å®Œå…¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰</p>
                        <p class="text-xs text-muted" style="margin: 0.25rem 0 0 0;">ãƒšãƒ¼ã‚¸é¸æŠæ™‚ã«OCRãƒ¢ãƒ‡ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã¦é€Ÿåº¦ã¨å“è³ªã®ãƒãƒ©ãƒ³ã‚¹ã‚’èª¿æ•´ - ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°æ¯”è¼ƒã‚’è¡¨ç¤º</p>
                    </div>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="color: #3B82F6;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="alert-banner-content" id="alert-content">
                    <div style="padding-left: 1.75rem; border-left: 3px solid #3B82F6; margin-left: 0.625rem;">
                        <div class="flex items-start gap-2 mb-3">
                            <svg class="icon-info" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="flex-shrink: 0; margin-top: 0.125rem;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-sm text-muted" style="margin: 0;">
                                <strong style="color: var(--color-text);">ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ©Ÿèƒ½:</strong> ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã€<code style="background: rgba(59,130,246,0.1); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.8125rem; color: #3B82F6; font-weight: 600;">gemini-2.5-flash-lite</code> ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦OCRãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºã‚’è¡Œã„ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®æ­£ç¢ºæ€§ã‚’ç¶­æŒã—ãªãŒã‚‰ç„¡æ–™APIã‚¯ã‚©ãƒ¼ã‚¿ã‚’å¤§å¹…ã«ç¯€ç´„ã—ã¾ã™ã€‚
                            </p>
                        </div>
                        <div class="flex items-start gap-2 mb-3">
                            <svg class="icon-info" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="flex-shrink: 0; margin-top: 0.125rem;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-sm text-muted" style="margin: 0;">
                                <strong style="color: var(--color-text);">ãƒ¢ãƒ‡ãƒ«æ§‹æˆï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰:</strong><br>
                                â€¢ ãƒ†ã‚­ã‚¹ãƒˆé™¤å»: <code style="background: rgba(0,0,0,0.08); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.8125rem;">gemini-2.5-flash-image</code> (æ¨™æº–ç‰ˆã€liteãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã—)<br>
                                â€¢ OCRæŠ½å‡º: <code style="background: rgba(59,130,246,0.1); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.8125rem; color: #3B82F6; font-weight: 600;">gemini-2.5-flash-lite</code> (Liteã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)<br>
                                <span style="color: var(--color-success); font-weight: 500;">âš¡ ä¸¡æ–¹ãŒåŒæ™‚ã«å®Ÿè¡Œã•ã‚Œã€å‡¦ç†æ™‚é–“ã‚’ç¯€ç´„</span>
                            </p>
                        </div>
                        <div class="flex items-start gap-2 mb-3">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="flex-shrink: 0; margin-top: 0.125rem; color: #10B981;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                            <p class="text-sm" style="margin: 0;">
                                <strong style="color: #10B981;">âœ… åˆ©ç‚¹:</strong><br>
                                â€¢ ä¸¦åˆ—å‡¦ç† â†’ ç´„40-50%ã®é€Ÿåº¦å‘ä¸Š<br>
                                â€¢ OCRã¯liteãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ â†’ ç´„50%ã®APIã‚¯ã‚©ãƒ¼ã‚¿ã‚’ç¯€ç´„<br>
                                â€¢ ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã¨ä½ç½®ã®æ¤œå‡ºã¯ä¾ç„¶ã¨ã—ã¦æ­£ç¢º<br>
                                <span style="font-size: 0.75rem; color: var(--color-text-light);">âš ï¸ <strong>è¦–è¦šçš„éšå±¤ãŒå¿…è¦ãªãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ä¸å‘ã</strong>ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã‚µã‚¤ã‚ºã€å¤ªå­—å¼·èª¿ã€è‰²åˆ†ã‘ãªã©ï¼‰</span>
                            </p>
                        </div>
                        <div class="flex items-start gap-2 mb-3">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="flex-shrink: 0; margin-top: 0.125rem; color: #DC2626;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <p class="text-sm text-muted" style="margin: 0;">
                                <strong style="color: #DC2626;">âš ï¸ ç¢ºèªã•ã‚ŒãŸåˆ¶é™:</strong> Liteãƒ¢ãƒ‡ãƒ«ã¯<strong>ãƒ•ã‚©ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“</strong>ï¼ˆãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã€å¤ªå­—ã€è‰²ãŒã™ã¹ã¦æ¬ è½ï¼‰ã€‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸPPTXã¯çµ±ä¸€ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã€å…ƒã®ãƒ‡ã‚¶ã‚¤ãƒ³ã®è¦–è¦šçš„éšå±¤ãŒå¤±ã‚ã‚Œã¾ã™ã€‚<br>
                                <span style="font-size: 0.75rem; color: var(--color-text-light); margin-top: 0.25rem; display: inline-block;">âœ… ä¿æŒ: ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã€ä½ç½®ã€é…ç½® | âŒ æ¬ è½: ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã€å¤ªã•ã€è‰²ã€è¡Œã®é«˜ã•</span>
                            </p>
                        </div>
                        <div class="flex items-start gap-2">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="flex-shrink: 0; margin-top: 0.125rem; color: #3B82F6;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                            </svg>
                            <p class="text-sm text-muted" style="margin: 0;">
                                <strong style="color: #3B82F6;">ğŸ“‹ ä½¿ç”¨æ¨å¥¨:</strong><br>
                                â€¢ <strong>é©ã—ãŸã‚·ãƒŠãƒªã‚ª</strong>: ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ¢ã€è­°äº‹éŒ²ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆè¦–è¦šçš„ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒé‡è¦ã§ãªã„å ´åˆï¼‰<br>
                                â€¢ <strong>ä¸å‘ã</strong>: ç¾ã—ã„ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ–ãƒ©ãƒ³ãƒ‰ã‚·ãƒ§ãƒ¼ã‚±ãƒ¼ã‚¹ã€æ•™è‚²ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆè¦–è¦šçš„éšå±¤ãŒå¿…è¦ï¼‰<br>
                                â€¢ <strong>å®Œå…¨ãªã‚¹ã‚¿ã‚¤ãƒ«ãŒå¿…è¦ãªå ´åˆ</strong>: æ¨™æº–ç‰ˆ <code style="background: rgba(0,0,0,0.08); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.8125rem;">index.html</code> ã‚’ä½¿ç”¨
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Optional Tools (Collapsible) -->
        <div class="text-center mb-8">
            <button class="collapsible-trigger" id="tools-trigger">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                </svg>
                PDF å‰å‡¦ç†ãƒ„ãƒ¼ãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            </button>
            <div class="collapsible-content" id="tools-content">
                <div class="tool-grid">
                    <a href="https://www.notebooklmwatermark.com/" target="_blank" rel="noopener noreferrer" class="tool-card">
                        <div class="tool-card-header">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                            <h3>é€ã‹ã—ã‚’å‰Šé™¤</h3>
                            <svg class="external-icon" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                        </div>
                        <p>NotebookLM ã®é€ã‹ã—ã‚’å‰Šé™¤ã—ã¦å‡¦ç†åŠ¹æœã‚’å‘ä¸Šã•ã›ã¾ã™</p>
                    </a>

                    <a href="https://shrinkpdf.com/" target="_blank" rel="noopener noreferrer" class="tool-card">
                        <div class="tool-card-header">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                            </svg>
                            <h3>PDF ã‚’åœ§ç¸®</h3>
                            <svg class="external-icon" width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                            </svg>
                        </div>
                        <p>ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¸®å°ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨å‡¦ç†ã‚’é«˜é€ŸåŒ–</p>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Sections -->
        <div id="upload-section" class="fade-in">
            <div class="card">
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    PDF ã¾ãŸã¯ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </h2>
                <div class="upload-zone" id="drop-zone">
                    <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="margin: 0 auto 1rem; color: var(--color-primary);">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <p style="font-weight: 600; margin-bottom: 0.25rem;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <p class="text-sm text-muted">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                    <p class="text-xs text-muted" style="margin-top: 0.5rem;">PDFã€PNGã€JPG å½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆ</p>
                    <input type="file" id="file-input" accept=".pdf,image/*" multiple style="display: none;">
                </div>
            </div>
        </div>

        <div id="selection-section" class="hidden fade-in">
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 style="font-size: 1.5rem; font-weight: 600; margin: 0;">å‡¦ç†ã™ã‚‹ãƒšãƒ¼ã‚¸ã‚’é¸æŠ</h2>
                    <div class="flex gap-2">
                        <button id="select-all-btn" class="btn-secondary text-sm">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            ã™ã¹ã¦é¸æŠ
                        </button>
                        <button id="deselect-all-btn" class="btn-secondary text-sm">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                            </svg>
                            ã™ã¹ã¦è§£é™¤
                        </button>
                    </div>
                </div>
                <div id="selection-grid" class="thumbnail-grid"></div>

                <!-- OCR Model Selection -->
                <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border: 2px solid #3B82F6; border-radius: 0.75rem;">
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="flex-shrink: 0; color: #3B82F6; margin-top: 0.125rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <div style="flex: 1;">
                            <label style="display: block; font-weight: 600; font-size: 1rem; color: #1E40AF; margin-bottom: 0.5rem;">
                                OCRãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ
                            </label>
                            <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem 1rem; background: white; border: 2px solid #3B82F6; border-radius: 0.5rem; flex: 1;">
                                    <input type="radio" name="ocr-model" value="lite" checked style="width: 1.125rem; height: 1.125rem; accent-color: #3B82F6; cursor: pointer;">
                                    <div>
                                        <div style="font-weight: 600; color: #1E293B;">âš¡ Liteãƒ¢ãƒ‡ãƒ«ï¼ˆæ¨å¥¨ï¼‰</div>
                                        <div class="text-xs text-muted">é«˜é€Ÿã€ã‚¯ã‚©ãƒ¼ã‚¿ç¯€ç´„ã€ãŸã ã—ã‚¹ã‚¿ã‚¤ãƒ«æ¤œå‡ºãªã—</div>
                                    </div>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem 1rem; background: white; border: 2px solid #E2E8F0; border-radius: 0.5rem; flex: 1;">
                                    <input type="radio" name="ocr-model" value="standard" style="width: 1.125rem; height: 1.125rem; accent-color: #3B82F6; cursor: pointer;">
                                    <div>
                                        <div style="font-weight: 600; color: #1E293B;">ğŸ¨ æ¨™æº–ãƒ¢ãƒ‡ãƒ«</div>
                                        <div class="text-xs text-muted">å®Œå…¨ãªã‚¹ã‚¿ã‚¤ãƒ«æ¤œå‡ºã€ãŸã ã—é…ãã€ã‚ˆã‚Šå¤šãã®ã‚¯ã‚©ãƒ¼ã‚¿ã‚’æ¶ˆè²»</div>
                                    </div>
                                </label>
                            </div>
                            <div id="ocr-model-info" class="text-xs text-muted" style="padding-left: 0.25rem;">
                                âš¡ <strong>Liteãƒ¢ãƒ‡ãƒ«</strong>: ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã¨ä½ç½®ãŒæ­£ç¢ºã€ãŸã ã—ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã€å¤ªã•ã€è‰²ã¯çµ±ä¸€ â†’ ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›ã«é©ã—ã¦ã„ã¾ã™
                            </div>
                        </div>
                    </div>
                </div>

                <button id="process-btn" class="btn btn-cta" style="width: 100%; margin-top: 1rem; font-size: 1.125rem; padding: 0.875rem 1.5rem;">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    å‡¦ç†é–‹å§‹
                </button>
            </div>
        </div>

        <div id="processing-section" class="hidden fade-in">
            <div class="card">
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">å‡¦ç†ä¸­...</h2>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm text-muted" style="margin-top: 0.5rem;">å‡¦ç†ã®æº–å‚™ä¸­...</p>
                <p id="progress-detail" class="text-xs text-muted" style="margin-top: 0.25rem;"></p>
            </div>
        </div>

        <div id="results-section" class="hidden fade-in">
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 style="font-size: 1.5rem; font-weight: 600; margin: 0;">å‡¦ç†å®Œäº†</h2>
                    <div class="flex gap-2">
                        <button id="export-btn" class="btn btn-cta">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            PPTX ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <button id="reset-btn" class="btn-secondary">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
                        </button>
                    </div>
                </div>
                <div id="results-grid" class="result-grid"></div>
            </div>
        </div>

        <!-- API Key Modal -->
        <div id="api-key-modal" class="hidden" style="position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; z-index: 1000;">
            <div class="card" style="max-width: 500px; width: 90%; margin: 0 1rem; animation: fadeIn 0.3s ease;">
                <h2 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 1rem;">API ã‚­ãƒ¼ã‚’è¨­å®š</h2>
                <p class="text-muted text-sm mb-4">ä½¿ç”¨ã‚’é–‹å§‹ã™ã‚‹ã«ã¯ Gemini API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>

                <div class="mb-4" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); padding: 1rem; border-radius: 0.5rem; border: 1px solid #f59e0b;">
                    <div class="flex items-start gap-2">
                        <svg class="icon-warning" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" style="flex-shrink: 0; margin-top: 0.125rem;">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <div>
                            <p class="text-sm mb-2 font-semibold" style="color: #d97706; margin: 0 0 0.5rem 0;">
                                ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®å‰²ã‚Šå½“ã¦åˆ¶é™
                            </p>
                            <p class="text-sm text-muted" style="margin: 0;">
                                <strong style="color: var(--color-text);">ç„¡æ–™ APIï¼š</strong>ç´„ <strong style="color: var(--color-text);">20 ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/æ—¥</strong>ã«åˆ¶é™ã•ã‚Œã¦ãŠã‚Šã€ç”»åƒ 1 æšã®å‡¦ç†ã« 2 ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¿…è¦ã§ã€1æ—¥ã‚ãŸã‚Šç´„ <strong style="color: var(--color-text);">10 æšã®ç”»åƒ</strong>ã‚’å‡¦ç†ã§ãã¾ã™ã€‚
                            </p>
                            <div class="flex items-center gap-1 mt-2">
                                <svg class="icon-success" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <p class="text-sm" style="color: var(--color-success); margin: 0;">
                                    æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ã¯ã“ã®åˆ¶é™ãŒãªãã€å¤§é‡å‡¦ç†ãŒå¯èƒ½
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-4" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.08)); padding: 1rem; border-radius: 0.5rem; border: 1px solid rgba(239, 68, 68, 0.3);">
                    <div class="flex items-start gap-2">
                        <svg class="icon-danger" width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="flex-shrink: 0; margin-top: 0.125rem;">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        <div>
                            <p class="text-sm mb-2 font-semibold" style="color: #dc2626; margin: 0 0 0.5rem 0;">
                                gen-lang-client ãƒã‚°ã‚’å›é¿
                            </p>
                            <p class="text-sm text-muted" style="margin: 0;">
                                API ã‚­ãƒ¼ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã« <code style="background: rgba(0,0,0,0.1); padding: 0.125rem 0.25rem; border-radius: 0.25rem;">gen-lang-client</code> ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€æ—¢çŸ¥ã®ãƒã‚°ã®å½±éŸ¿ã‚’å—ã‘ã¦ä½¿ç”¨ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>
                                <strong style="color: var(--color-text);">è§£æ±ºæ–¹æ³•ï¼š</strong>Google Cloud Console ã§<strong>ã‚«ã‚¹ã‚¿ãƒ åã®æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</strong>ï¼ˆä¾‹ï¼šã€Œmy-notebook-pptxã€ï¼‰ã‚’ä½œæˆã—ã€ãã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ API ã‚­ãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mb-4" style="background: var(--color-bg); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--color-border);">
                    <p class="text-sm mb-2">
                        <strong>API ã‚­ãƒ¼ã®å–å¾—æ–¹æ³•ï¼š</strong>
                    </p>
                    <ol class="text-sm text-muted" style="padding-left: 1.25rem; line-height: 1.8; margin: 0;">
                        <li><a href="https://console.cloud.google.com/projectcreate" target="_blank" style="color: var(--color-primary); text-decoration: underline;">Google Cloud Console</a> ã§æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆï¼ˆã‚«ã‚¹ã‚¿ãƒ åï¼‰</li>
                        <li><a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--color-primary); text-decoration: underline;">Google AI Studio</a> ã«ã‚¢ã‚¯ã‚»ã‚¹</li>
                        <li>ã€ŒCreate API Keyã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ä½œæˆã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ</li>
                        <li>ç”Ÿæˆã•ã‚ŒãŸ API ã‚­ãƒ¼ã‚’ã‚³ãƒ”ãƒ¼</li>
                    </ol>
                </div>

                <input
                    type="password"
                    id="api-key-input"
                    placeholder="Gemini API ã‚­ãƒ¼ã‚’å…¥åŠ›ï¼ˆAIza ã§å§‹ã¾ã‚‹ï¼‰"
                    style="width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--color-border); border-radius: 0.5rem; font-size: 0.9375rem; margin-bottom: 1rem;"
                >

                <button id="save-api-key-btn" class="btn" style="width: 100%;">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                    </svg>
                    ä¿å­˜ã—ã¦ä½¿ç”¨ã‚’é–‹å§‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // API Key ç”±ç”¨æˆ¶åœ¨ä»‹é¢ä¸­è¼¸å…¥ï¼Œå„²å­˜åœ¨ localStorage
        let apiKey = localStorage.getItem('gemini_api_key') || "";

        // ä½¿ç”¨ç©©å®šç‰ˆæ¨¡å‹
        // Model configuration (user selectable)
        const MODEL_IMAGE_EDIT = "gemini-2.5-flash-image";  // Image editing has no lite version
        let MODEL_TEXT_GEN = "gemini-2.5-flash-lite";       // Default to lite model

        // ç‹€æ…‹ç®¡ç†
        let pendingItems = [];
        let results = [];
        let rateLimitCount = 0;

        // OCR Model Selection Handler
        document.querySelectorAll('input[name="ocr-model"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const infoDiv = document.getElementById('ocr-model-info');
                if (e.target.value === 'lite') {
                    MODEL_TEXT_GEN = "gemini-2.5-flash-lite";
                    infoDiv.innerHTML = 'âš¡ <strong>Liteãƒ¢ãƒ‡ãƒ«</strong>: ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã¨ä½ç½®ãŒæ­£ç¢ºã€ãŸã ã—ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã€å¤ªã•ã€è‰²ã¯çµ±ä¸€ â†’ ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›ã«é©ã—ã¦ã„ã¾ã™';
                } else {
                    MODEL_TEXT_GEN = "gemini-2.5-flash";
                    infoDiv.innerHTML = 'ğŸ¨ <strong>æ¨™æº–ãƒ¢ãƒ‡ãƒ«</strong>: ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã€å¤ªå­—ã€è‰²ãªã©ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®Œå…¨ã«æ¤œå‡º â†’ è¦–è¦šçš„éšå±¤ã‚’ä¿æŒã€ç¾ã—ã„ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«é©ã—ã¦ã„ã¾ã™';
                }
                console.log(`OCR model switched to: ${MODEL_TEXT_GEN}`);
            });
        });

        // Alert Banner Toggle
        document.getElementById('alert-header').addEventListener('click', function() {
            this.classList.toggle('expanded');
            document.getElementById('alert-content').classList.toggle('expanded');
        });

        // Tools Collapsible
        document.getElementById('tools-trigger').addEventListener('click', function() {
            this.classList.toggle('active');
            document.getElementById('tools-content').classList.toggle('active');
        });

        function initPdfLibrary() {
            try {
                if (window.pdfjsLib) {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    return true;
                }
            } catch (e) { console.error(e); }
            showToast('PDF.js ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„');
            return false;
        }

        // UI Elements
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadSection = document.getElementById('upload-section');
        const selectionSection = document.getElementById('selection-section');
        const processingSection = document.getElementById('processing-section');
        const resultsSection = document.getElementById('results-section');

        // Check API Key
        if (!apiKey) {
            showApiKeyModal();
        }

        function showApiKeyModal() {
            const modal = document.getElementById('api-key-modal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
            }
        }

        function hideApiKeyModal() {
            const modal = document.getElementById('api-key-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        document.getElementById('save-api-key-btn').onclick = () => {
            const input = document.getElementById('api-key-input');
            const key = input.value.trim();
            if (!key) {
                showToast('API ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!key.startsWith('AIza')) {
                showToast('API ã‚­ãƒ¼ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚AIza ã§å§‹ã¾ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                return;
            }
            localStorage.setItem('gemini_api_key', key);
            apiKey = key;
            hideApiKeyModal();
            showToast('API ã‚­ãƒ¼ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸ');
        };

        // File Upload
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFiles(e.target.files);

        dropZone.ondragover = (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        };

        dropZone.ondragleave = () => {
            dropZone.classList.remove('dragover');
        };

        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        };

        async function handleFiles(files) {
            if (!initPdfLibrary()) return;

            pendingItems = [];
            const fileArray = Array.from(files);

            for (const file of fileArray) {
                if (file.type === 'application/pdf') {
                    const pages = await loadPdfPages(file);
                    pendingItems.push(...pages);
                } else if (file.type.startsWith('image/')) {
                    const dataUrl = await readFileAsDataURL(file);
                    pendingItems.push({
                        type: 'image',
                        name: file.name,
                        thumbnail: dataUrl,
                        fullImage: dataUrl,
                        selected: true
                    });
                }
            }

            if (pendingItems.length > 0) {
                uploadSection.classList.add('hidden');
                selectionSection.classList.remove('hidden');
                renderSelectionGrid();
            }
        }

        async function loadPdfPages(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const pages = [];

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const thumbnail = await renderPage(page, 0.5);
                const fullImage = await renderPage(page, 2.0);

                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str).join(' ').trim();

                pages.push({
                    type: 'pdf',
                    name: `${file.name} - ãƒšãƒ¼ã‚¸ ${i}`,
                    pageNum: i,
                    thumbnail,
                    fullImage,
                    text,
                    selected: true
                });
            }

            return pages;
        }

        async function renderPage(page, scale) {
            const viewport = page.getViewport({ scale });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport }).promise;
            return canvas.toDataURL('image/png');
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function renderSelectionGrid() {
            const grid = document.getElementById('selection-grid');
            grid.innerHTML = pendingItems.map((item, idx) => `
                <div class="thumbnail-item ${item.selected ? 'selected' : ''}" data-index="${idx}">
                    <div class="checkbox-wrapper" style="position: absolute; top: 0.5rem; right: 0.5rem; z-index: 10;">
                        <input type="checkbox" ${item.selected ? 'checked' : ''}>
                        <div class="checkbox-custom">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                    </div>
                    <img src="${item.thumbnail}" alt="${item.name}" style="width: 100%; height: auto; display: block; border-radius: 0.25rem;">
                    <p class="text-xs text-muted" style="margin-top: 0.5rem; text-align: center;">${item.name}</p>
                </div>
            `).join('');

            document.querySelectorAll('.thumbnail-item').forEach(el => {
                el.onclick = () => {
                    const idx = parseInt(el.dataset.index);
                    pendingItems[idx].selected = !pendingItems[idx].selected;
                    renderSelectionGrid();
                };
            });
        }

        document.getElementById('select-all-btn').onclick = () => {
            pendingItems.forEach(i => i.selected = true);
            renderSelectionGrid();
        };

        document.getElementById('deselect-all-btn').onclick = () => {
            pendingItems.forEach(i => i.selected = false);
            renderSelectionGrid();
        };

        document.getElementById('process-btn').onclick = async () => {
            const selected = pendingItems.filter(i => i.selected);
            if (selected.length === 0) {
                showToast('å°‘ãªãã¨ã‚‚ 1 ã¤ã®é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            selectionSection.classList.add('hidden');
            processingSection.classList.remove('hidden');
            await processItems(selected);
        };

        async function processItems(items) {
            results = [];
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const progressDetail = document.getElementById('progress-detail');

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const progress = ((i + 1) / items.length) * 100;
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `å‡¦ç†ä¸­ï¼š${i + 1} / ${items.length}`;
                progressDetail.textContent = `å‡¦ç†ä¸­ï¼š${item.name}`;

                try {
                    // Parallel processing: run text removal and OCR simultaneously (saves time and avoids duplicate API calls)
                    progressDetail.textContent = "AI ãŒãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤ã—ã€å†…å®¹ã‚’èªè­˜ä¸­ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰...";

                    let cleaned = null;
                    let ocrBlocks = [];
                    let cleanedError = null;
                    let ocrError = null;

                    // Use Promise.allSettled to run both API calls in parallel
                    const [cleanedResult, ocrResult] = await Promise.allSettled([
                        removeTextWithGemini(item.fullImage),
                        ocrWithGemini(item.fullImage)
                    ]);

                    // Handle text removal result
                    if (cleanedResult.status === 'fulfilled') {
                        cleaned = cleanedResult.value;
                    } else {
                        console.error("ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤å¤±æ•—:", cleanedResult.reason);
                        cleanedError = cleanedResult.reason;
                    }

                    // Handle OCR result
                    if (ocrResult.status === 'fulfilled') {
                        ocrBlocks = ocrResult.value || [];
                        console.log(`OCR æˆåŠŸï¼š${ocrBlocks.length} å€‹ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¤œå‡º`);

                        // DEBUG: Display style detection details
                        if (ocrBlocks.length > 0) {
                            const modelLabel = MODEL_TEXT_GEN.includes('lite') ? 'Liteãƒ¢ãƒ‡ãƒ«' : 'æ¨™æº–ãƒ¢ãƒ‡ãƒ«';
                            console.group(`ğŸ“Š [${modelLabel}] ã‚¹ã‚¿ã‚¤ãƒ«æ¤œå‡ºè©³ç´° - ${item.name}`);
                            const fontSizes = new Set(ocrBlocks.map(b => b.font_size_pt));
                            const fontWeights = new Set(ocrBlocks.map(b => b.font_weight));
                            const colors = new Set(ocrBlocks.map(b => b.color));
                            console.log('ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã®ç¨®é¡:', Array.from(fontSizes).sort((a,b) => a-b));
                            console.log('ãƒ•ã‚©ãƒ³ãƒˆã‚¦ã‚§ã‚¤ãƒˆã®ç¨®é¡:', Array.from(fontWeights));
                            console.log('è‰²ã®ç¨®é¡:', Array.from(colors));
                            console.log('æœ€åˆã®3ã¤ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚µãƒ³ãƒ—ãƒ«:');
                            ocrBlocks.slice(0, 3).forEach((block, i) => {
                                console.log(`  [${i+1}] "${block.text.substring(0, 30)}..."`, {
                                    fontSize: block.font_size_pt,
                                    weight: block.font_weight,
                                    style: block.font_style,
                                    color: block.color
                                });
                            });
                            console.groupEnd();
                        }
                    } else {
                        console.warn("OCR å¤±æ•—ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ™‚ã«ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™:", ocrResult.reason);
                        ocrError = ocrResult.reason;
                    }

                    // Continue if text removal failed but OCR succeeded (can use original image + text layer)
                    if (cleanedError && !cleaned && !ocrBlocks.length) {
                        throw cleanedError; // Only throw error if both failed
                    }

                    results.push({
                        name: item.name,
                        original: item.fullImage,
                        cleaned: cleaned || item.fullImage,
                        textBlocks: ocrBlocks
                    });
                } catch (error) {
                    console.error("å‡¦ç†å¤±æ•—:", error);
                    showToast(`å‡¦ç†å¤±æ•—ï¼š${error.message}`);
                    results.push({
                        name: item.name,
                        original: item.fullImage,
                        cleaned: item.fullImage,
                        textBlocks: [],
                        error: error.message
                    });
                }

                if (i < items.length - 1) await wait(1500);
            }

            processingSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            renderResults();
        }

        function renderResults() {
            const grid = document.getElementById('results-grid');
            grid.innerHTML = results.map((r, idx) => `
                <div class="result-card">
                    <img src="${r.cleaned}" alt="${r.name}">
                    <div class="result-card-content">
                        <p class="text-sm font-semibold">${r.name}</p>
                        ${r.error ? `<p class="text-xs" style="color: var(--color-danger);">ã‚¨ãƒ©ãƒ¼ï¼š${r.error}</p>` : ''}
                        ${r.textBlocks.length > 0 ? `<p class="text-xs text-muted">${r.textBlocks.length} å€‹ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯</p>` : ''}
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('export-btn').onclick = async () => {
            console.log('PPTX ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚’é–‹å§‹ã€results:', results);

            const pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';

            for (let i = 0; i < results.length; i++) {
                const result = results[i];
                console.log(`ã‚¹ãƒ©ã‚¤ãƒ‰ ${i+1} ã‚’å‡¦ç†ä¸­:`, {
                    name: result.name,
                    textBlocksCount: result.textBlocks?.length || 0,
                    textBlocks: result.textBlocks
                });

                const slide = pptx.addSlide();
                slide.addImage({ data: result.cleaned, x: 0, y: 0, w: '100%', h: '100%' });

                if (result.textBlocks && result.textBlocks.length > 0) {
                    console.log(`ã‚¹ãƒ©ã‚¤ãƒ‰ ${i+1} ã« ${result.textBlocks.length} å€‹ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ `);

                    result.textBlocks.forEach((block, idx) => {
                        if (!block.text || !block.text.trim()) {
                            console.warn(`ç©ºã®ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ ${idx} ã‚’ã‚¹ã‚­ãƒƒãƒ—`);
                            return;
                        }
                        if (!block.box_2d || block.box_2d.length !== 4) {
                            console.warn(`ç„¡åŠ¹ãªåº§æ¨™ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ ${idx} ã‚’ã‚¹ã‚­ãƒƒãƒ—:`, block);
                            return;
                        }

                        const [ymin, xmin, ymax, xmax] = block.box_2d;

                        const textOptions = {
                            x: `${xmin/10}%`,
                            y: `${ymin/10}%`,
                            w: `${Math.max((xmax-xmin)/10, 5)}%`,
                            h: `${Math.max((ymax-ymin)/10, 2)}%`,
                            fontSize: block.font_size_pt || 14,
                            color: (block.color || "000000").replace("#", ""),
                            fontFace: 'Yu Gothic',
                            valign: 'top'
                        };

                        if (block.font_weight === 'bold') textOptions.bold = true;
                        if (block.font_style === 'italic') textOptions.italic = true;
                        if (block.text_align) textOptions.align = block.text_align;

                        console.log(`ãƒ†ã‚­ã‚¹ãƒˆ "${block.text.substring(0, 20)}..." ã‚’ä½ç½®ã«è¿½åŠ :`, textOptions);
                        slide.addText(block.text, textOptions);
                    });
                } else {
                    console.warn(`ã‚¹ãƒ©ã‚¤ãƒ‰ ${i+1} ã«ãƒ†ã‚­ã‚¹ãƒˆãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“`);
                }
            }

            await pptx.writeFile({ fileName: `NotebookLM_${Date.now()}.pptx` });
            showToast('PPTX ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæˆåŠŸï¼');
        };

        document.getElementById('reset-btn').onclick = () => {
            pendingItems = [];
            results = [];
            resultsSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            fileInput.value = '';
        };

        async function removeTextWithGemini(base64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE_EDIT}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        { text: "Remove all text from this image while preserving the background." },
                        { inlineData: { mimeType: "image/png", data: base64.split(',')[1] } }
                    ]
                }],
                generationConfig: {
                    temperature: 0.4,
                    topK: 32,
                    topP: 1,
                    maxOutputTokens: 4096
                }
            };

            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!data || !data.candidates) {
                console.error('API ãŒç•°å¸¸ãªãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã—ãŸ:', data);
                throw new Error('ç„¡æ–™ãƒ—ãƒ©ãƒ³ã® API å‰²ã‚Šå½“ã¦ãŒä½¿ã„æœãŸã•ã‚ŒãŸã‹ã€ã‚µãƒ¼ãƒ“ã‚¹ã«ç•°å¸¸ãŒã‚ã‚Šã¾ã™ï¼ˆ1æ—¥ã‚ãŸã‚Šç´„ 20 ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åˆ¶é™ï¼‰ã€‚æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ã¯ã“ã®åˆ¶é™ãŒã‚ã‚Šã¾ã›ã‚“');
            }

            const finishReason = data.candidates?.[0]?.finishReason;
            if (finishReason === 'IMAGE_RECITATION') {
                throw new Error("ç”»åƒå‡¦ç†ãŒåˆ¶é™ã•ã‚Œã¾ã—ãŸï¼šGemini ãŒè‘—ä½œæ¨©ã®å•é¡Œã‚’æ¤œå‡ºã—ã¾ã—ãŸ");
            }

            const part = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
            if (!part) {
                console.error('API ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ :', JSON.stringify(data, null, 2));
                throw new Error(data.error?.message || "API ãŒç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã›ã‚“ã§ã—ãŸã€‚å‰²ã‚Šå½“ã¦åˆ¶é™ã«é”ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™");
            }
            return 'data:image/png;base64,' + part.inlineData.data;
        }

        async function ocrWithGemini(base64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT_GEN}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [
                        {
                            text: `Analyze this image and extract all text blocks with precise positioning and styling.
For each text block, provide:
- text: the exact text content
- box_2d: bounding box as [ymin, xmin, ymax, xmax] in 0-1000 coordinate system
- font_size_pt: estimated font size in points (typical range: 8-72)
- font_weight: "normal" or "bold"
- font_style: "normal" or "italic"
- text_align: "left", "center", or "right"
- color: hex color code like "000000" or "FFFFFF"
- line_height: line height multiplier (typically 1.0-2.0)

Return as JSON array.`
                        },
                        { inlineData: { mimeType: "image/png", data: base64.split(',')[1] } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                text: { type: "STRING" },
                                box_2d: { type: "ARRAY", items: { type: "NUMBER" }, minItems: 4, maxItems: 4 },
                                font_size_pt: { type: "NUMBER" },
                                font_weight: { type: "STRING" },
                                font_style: { type: "STRING" },
                                text_align: { type: "STRING" },
                                color: { type: "STRING" },
                                line_height: { type: "NUMBER" }
                            }
                        }
                    }
                }
            };

            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            console.log('OCR API ãŒè¿”ã—ãŸãƒ‡ãƒ¼ã‚¿:', data);

            if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                console.warn('OCR API ãŒãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã‚’è¿”ã—ã¾ã›ã‚“ã§ã—ãŸ');
                return [];
            }

            try {
                const rawText = data.candidates[0].content.parts[0].text;
                console.log('OCR å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ:', rawText);
                const parsed = JSON.parse(rawText);
                console.log('OCR è§£æçµæœ:', parsed);
                return parsed;
            } catch (e) {
                console.error("OCR JSON è§£æå¤±æ•—:", e);
                console.error("å…ƒã®å†…å®¹:", data.candidates[0].content.parts[0].text);
                return [];
            }
        }

        async function fetchWithRetry(url, options, maxRetries = 5) {
            const delays = [2000, 4000, 8000, 16000, 32000];
            let lastError = null;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    const text = await response.text();

                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (parseError) {
                        const preview = text.substring(0, 200);
                        console.error(`JSON è§£æå¤±æ•—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…å®¹: ${preview}`);
                        if (text.includes('API key not valid') || text.includes('API_KEY_INVALID')) {
                            throw new Error('API ã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚Gemini API ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                        }
                        if (text.trim() === '' || text.length < 10) {
                            throw new Error('ç„¡æ–™ãƒ—ãƒ©ãƒ³ã® API å‰²ã‚Šå½“ã¦ãŒä½¿ã„æœãŸã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆ1æ—¥ã‚ãŸã‚Šç´„ 20 ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åˆ¶é™ï¼‰ã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ã„ãŸã ãã‹ã€æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼ˆç„¡åˆ¶é™ï¼‰');
                        }
                        throw new Error(`API ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚¨ãƒ©ãƒ¼: ${preview}...`);
                    }

                    if (response.ok) return data;

                    if (response.status === 429) {
                        rateLimitCount++;
                        const errorMsg = data.error?.message || '';

                        if (errorMsg.includes('quota') || errorMsg.includes('RESOURCE_EXHAUSTED')) {
                            throw new Error('ç„¡æ–™ãƒ—ãƒ©ãƒ³ã® 1æ—¥ã‚ãŸã‚Šã®å‰²ã‚Šå½“ã¦ãŒä½¿ã„æœãŸã•ã‚Œã¾ã—ãŸï¼ˆ1æ—¥ã‚ãŸã‚Šç´„ 20 ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®åˆ¶é™ï¼‰ã€‚æ˜æ—¥ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ã„ãŸã ãã‹ã€æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼ˆç„¡åˆ¶é™ï¼‰ã€‚');
                        }

                        if (i < maxRetries - 1) {
                            console.warn(`ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€${delays[i]}ms å¾…æ©Ÿå¾Œã«å†è©¦è¡Œ (${i + 1}/${maxRetries})`);
                            await wait(delays[i]);
                            continue;
                        }
                    }

                    if (response.status === 403) {
                        const errorMsg = data.error?.message || '';
                        if (errorMsg.includes('quota') || errorMsg.includes('exceeded')) {
                            throw new Error('ç„¡æ–™ãƒ—ãƒ©ãƒ³ã® API å‰²ã‚Šå½“ã¦åˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸï¼ˆ1æ—¥ã‚ãŸã‚Šç´„ 20 ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰ã€‚ç„¡åˆ¶é™ã®ä½¿ç”¨ã«ã¯æœ‰æ–™ãƒ—ãƒ©ãƒ³ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                        }
                    }

                    throw new Error(data.error?.message || `HTTP ${response.status}`);

                } catch (e) {
                    lastError = e;

                    if (e.message.includes('å‰²ã‚Šå½“ã¦') ||
                        e.message.includes('ã‚­ãƒ¼') ||
                        e.message.includes('API key')) {
                        throw e;
                    }

                    if (i === maxRetries - 1) {
                        throw new Error(`API ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—ï¼ˆ${maxRetries} å›å†è©¦è¡Œï¼‰: ${e.message}`);
                    }

                    console.warn(`ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—ã€2 ç§’å¾…æ©Ÿå¾Œã«å†è©¦è¡Œ: ${e.message}`);
                    await wait(2000);
                }
            }
            throw lastError || new Error('API ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—ï¼šä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
