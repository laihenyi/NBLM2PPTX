<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åœ–ç‰‡æ–‡å­—ç§»é™¤ PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; }
        .drop-zone-active { border-color: #3b82f6 !important; background-color: rgba(59, 130, 246, 0.1) !important; transform: scale(1.02); }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .result-card { transition: all 0.3s ease; }
        .result-card:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .progress-bar { transition: width 0.3s ease; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* Checkbox Custom Style */
        .custom-checkbox:checked + div {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.2);
        }
        .custom-checkbox:checked + div .check-icon {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="text-white pb-20">
    <div class="max-w-6xl mx-auto px-4 py-12">
        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-black tracking-tight mb-3">
                AI åœ–ç‰‡æ–‡å­—ç§»é™¤ <span class="text-blue-400">PRO</span>
            </h1>
            <p class="text-slate-400 text-lg">ä¸Šå‚³ PDF æˆ–åœ–ç‰‡ â†’ é¸æ“‡é é¢ â†’ è‡ªå‹•å»å­— â†’ å°å‡ºé›™ PPTX</p>
            <div class="flex items-center justify-center gap-4 mt-4">
                <span class="flex items-center gap-2 text-xs text-blue-400">
                    <span class="w-2 h-2 bg-blue-400 rounded-full animate-pulse"></span>
                    Powered by Gemini 2.5
                </span>
            </div>
            <div id="api-key-status" class="mt-6 mx-auto max-w-2xl rounded-2xl p-4 text-sm hidden">
                <!-- å‹•æ…‹é¡¯ç¤º API Key ç‹€æ…‹ -->
            </div>
        </header>

        <!-- ä¸»ä¸Šå‚³å€ -->
        <section id="upload-section" class="mb-10 transition-all duration-300">
            <div id="drop-zone" class="glass rounded-3xl p-16 text-center cursor-pointer hover:border-blue-500/50 transition-all duration-300 group">
                <input type="file" id="file-input" class="hidden" accept="application/pdf,image/*" multiple>
                <div class="w-20 h-20 bg-blue-500/20 text-blue-400 rounded-2xl flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </div>
                <p class="text-2xl font-bold text-white mb-2">æ‹–æ”¾ PDF æˆ–åœ–ç‰‡</p>
                <p class="text-slate-400">é»æ“Šæ­¤è™•é¸æ“‡æª”æ¡ˆ</p>
                <div id="lib-warning" class="mt-4 text-xs text-amber-400 hidden">è­¦å‘Šï¼šçµ„ä»¶å°šæœªå°±ç·’ï¼Œè«‹ç¨å€™...</div>
            </div>
        </section>

        <!-- é¸æ“‡é é¢å€ -->
        <section id="selection-section" class="hidden mb-10 animate-fade-in">
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                <div>
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <span class="bg-blue-500 w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
                        é¸æ“‡è¦è™•ç†çš„é é¢
                    </h2>
                    <p class="text-slate-400 text-sm mt-1 ml-10">åƒ…å‹¾é¸éœ€è¦çš„é é¢ä»¥ç¯€çœæ™‚é–“</p>
                </div>
                <div class="flex gap-3">
                    <button id="select-all-btn" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm font-bold transition">å…¨é¸</button>
                    <button id="deselect-all-btn" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 text-sm font-bold transition">å…¨å–æ¶ˆ</button>
                    <button id="start-process-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/20 transition flex items-center gap-2">
                        é–‹å§‹è™•ç† (<span id="selected-count">0</span>)
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </div>
            </div>

            <div id="selection-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 custom-scrollbar max-h-[60vh] overflow-y-auto p-2">
                <!-- ç¸®åœ–å°‡ç”Ÿæˆæ–¼æ­¤ -->
            </div>
        </section>

        <!-- è™•ç†é€²åº¦å€ -->
        <section id="progress-section" class="hidden mb-10">
            <div class="glass rounded-3xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="loader"></div>
                        <div>
                            <p id="progress-title" class="font-bold text-lg">è™•ç†ä¸­...</p>
                            <p id="progress-detail" class="text-sm text-slate-400">åˆ†æä¸­</p>
                        </div>
                    </div>
                    <span id="progress-count" class="text-2xl font-black text-blue-400">0/0</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                    <div id="progress-bar" class="progress-bar bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </section>

        <!-- çµæœå€ -->
        <section id="results-section" class="hidden">
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4 border-t border-slate-700 pt-8">
                <div>
                    <h2 class="text-2xl font-bold flex items-center gap-2">
                        <span class="bg-emerald-500 w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
                        è™•ç†çµæœ
                    </h2>
                </div>
                <div class="flex items-center gap-3 flex-wrap">
                    <select id="ratio-select" class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-sm font-bold outline-none">
                        <option value="16:9">16:9 æ©«å¼</option>
                        <option value="9:16">9:16 ç›´å¼</option>
                        <option value="4:3">4:3 æ¨™æº–</option>
                    </select>
                    <button id="export-combined-btn" class="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg transition flex items-center gap-2">
                        åˆä½µ PPTX â­
                    </button>
                    <button id="reset-btn" class="bg-red-600/20 hover:bg-red-600/30 text-red-400 px-4 py-2.5 rounded-xl font-bold transition">é‡æ–°é–‹å§‹</button>
                </div>
            </div>
            <div id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 custom-scrollbar"></div>
        </section>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-2xl opacity-0 transition-all pointer-events-none z-50 text-sm font-bold border border-slate-700"></div>

    <!-- API Key è¨­å®šæ¨¡æ…‹è¦–çª— -->
    <div id="api-key-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="glass rounded-3xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-black">ğŸ”‘ è¨­å®š Gemini API Key</h2>
                <button id="close-modal" class="text-slate-400 hover:text-white transition text-2xl">&times;</button>
            </div>

            <div class="space-y-6">
                <!-- æ­¥é©Ÿèªªæ˜ -->
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-2xl p-5">
                    <h3 class="font-bold text-blue-400 mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        ç‚ºä»€éº¼éœ€è¦ API Keyï¼Ÿ
                    </h3>
                    <p class="text-sm text-slate-300 leading-relaxed">
                        æœ¬å·¥å…·ä½¿ç”¨ Google Gemini AI é€²è¡Œåœ–ç‰‡è™•ç†ã€‚ç‚ºäº†è®“æ¯ä½ä½¿ç”¨è€…éƒ½èƒ½äº«æœ‰ç©©å®šçš„æœå‹™å“è³ªï¼Œè«‹ä½¿ç”¨æ‚¨è‡ªå·±çš„ API Keyã€‚
                        <strong class="text-blue-400">Google æä¾›å…è²»é¡åº¦</strong>ï¼Œæ¯æœˆå¯è™•ç†å¤§é‡åœ–ç‰‡ï¼Œå®Œå…¨å…è²»ï¼
                    </p>
                </div>

                <!-- ç”³è«‹æ­¥é©Ÿ -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="font-bold text-lg">ğŸ“ å¦‚ä½•å–å¾— API Keyï¼ˆ3 æ­¥é©Ÿï¼‰</h3>
                        <span class="text-xs text-slate-400">é¦–æ¬¡ç”³è«‹æˆ–æ‰¾å›æ—¢æœ‰çš„ Key</span>
                    </div>

                    <div class="space-y-3">
                        <div class="flex gap-4 bg-slate-700/30 rounded-xl p-4">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center font-bold">1</div>
                            <div class="flex-1">
                                <p class="font-bold mb-1">å‰å¾€ Google AI Studio</p>
                                <a href="https://aistudio.google.com/apikey" target="_blank" class="text-blue-400 hover:text-blue-300 underline text-sm flex items-center gap-1">
                                    https://aistudio.google.com/apikey
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                                </a>
                                <p class="text-xs text-slate-400 mt-1">ä½¿ç”¨ä½ çš„ Google å¸³è™Ÿç™»å…¥</p>
                            </div>
                        </div>

                        <div class="flex gap-4 bg-slate-700/30 rounded-xl p-4">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center font-bold">2</div>
                            <div class="flex-1">
                                <p class="font-bold mb-1">å–å¾—æˆ–å»ºç«‹ API Key</p>
                                <p class="text-sm text-slate-300">
                                    â€¢ <strong>å·²æœ‰ Keyï¼Ÿ</strong>åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸¦é»æ“Šã€Œè¤‡è£½ã€åœ–ç¤º<br>
                                    â€¢ <strong>é¦–æ¬¡ä½¿ç”¨ï¼Ÿ</strong>é»æ“Šã€ŒCreate API Keyã€å»ºç«‹æ–°çš„
                                </p>
                                <p class="text-xs text-slate-400 mt-1">ğŸ’¡ å»ºç«‹æ™‚é¸æ“‡ã€ŒCreate API key in new projectã€å³å¯</p>
                            </div>
                        </div>

                        <div class="flex gap-4 bg-slate-700/30 rounded-xl p-4">
                            <div class="flex-shrink-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center font-bold">3</div>
                            <div class="flex-1">
                                <p class="font-bold mb-1">è¤‡è£½ä¸¦è²¼ä¸Š API Key</p>
                                <p class="text-sm text-slate-300">
                                    è¤‡è£½å¾Œï¼Œé»æ“Šä¸Šæ–¹ã€Œ<strong class="text-purple-400">ğŸ“‹ è‡ªå‹•è²¼ä¸Š</strong>ã€æŒ‰éˆ•å³å¯<br>
                                    <span class="text-xs">ï¼ˆæˆ–æ‰‹å‹•è²¼ä¸Šåˆ°ä¸‹æ–¹æ¬„ä½ï¼‰</span>
                                </p>
                                <p class="text-xs text-emerald-400 mt-1">âœ“ API Key åªæœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œéå¸¸å®‰å…¨</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿè·¯å¾‘ -->
                <div id="quick-path" class="bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/30 rounded-2xl p-4 mb-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">âš¡</span>
                            <div>
                                <p class="font-bold text-purple-400">å·²ç¶“æœ‰ API Keyï¼Ÿ</p>
                                <p class="text-xs text-slate-300">ç›´æ¥è²¼ä¸Šå³å¯å¿«é€Ÿé–‹å§‹</p>
                            </div>
                        </div>
                        <button id="paste-from-clipboard" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 rounded-xl text-sm font-bold transition flex items-center gap-2">
                            ğŸ“‹ è‡ªå‹•è²¼ä¸Š
                        </button>
                    </div>
                </div>

                <!-- API Key è¼¸å…¥ -->
                <div>
                    <label class="block text-sm font-bold mb-2">æ‚¨çš„ API Key</label>
                    <div class="flex gap-2">
                        <input
                            type="password"
                            id="api-key-input"
                            placeholder="è²¼ä¸Šä½ çš„ API Keyï¼ˆAIza...ï¼‰æˆ–é»æ“Šå³å´ã€Œè‡ªå‹•è²¼ä¸Šã€"
                            class="flex-1 bg-slate-800 border border-slate-600 rounded-xl px-4 py-3 outline-none focus:border-blue-500 transition font-mono text-sm"
                        >
                        <button id="toggle-visibility" class="px-4 bg-slate-700 hover:bg-slate-600 rounded-xl transition" title="é¡¯ç¤º/éš±è—">
                            ğŸ‘ï¸
                        </button>
                    </div>
                    <div class="flex items-start gap-2 mt-2 text-xs">
                        <svg class="w-4 h-4 inline text-slate-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                        <p class="text-slate-400">
                            æ‚¨çš„ API Key åƒ…å„²å­˜åœ¨æœ¬åœ°ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚
                            <span class="text-blue-400 cursor-pointer hover:underline" id="show-existing-key-tip">å·²æœ‰ API Key åœ¨å“ªæ‰¾ï¼Ÿ</span>
                        </p>
                    </div>
                </div>

                <!-- å„²å­˜æŒ‰éˆ• -->
                <div class="flex gap-3 pt-4">
                    <button id="save-api-key" class="flex-1 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition">
                        ğŸ’¾ å„²å­˜ä¸¦é–‹å§‹ä½¿ç”¨
                    </button>
                </div>

                <!-- å…è²»é¡åº¦èªªæ˜ -->
                <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4 text-xs text-slate-300">
                    <p class="font-bold text-emerald-400 mb-1">âœ¨ å…è²»é¡åº¦èªªæ˜</p>
                    <p>Gemini API å…è²»æ–¹æ¡ˆæ¯åˆ†é˜å¯è™•ç† 15 å¼µåœ–ç‰‡ï¼Œæ¯å¤© 1500 å¼µã€‚å°ä¸€èˆ¬ä½¿ç”¨ä¾†èªªç¶½ç¶½æœ‰é¤˜ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Key å°‡ç”±ç”¨æˆ¶åœ¨ä»‹é¢ä¸­è¼¸å…¥ï¼Œä¸¦å„²å­˜åœ¨ localStorage
        let apiKey = localStorage.getItem('gemini_api_key') || "";

        const MODEL_IMAGE_EDIT = "gemini-2.5-flash-image";
        const MODEL_TEXT_GEN = "gemini-2.5-flash";

        // ç‹€æ…‹ç®¡ç†
        let pendingItems = [];
        let results = [];

        function initPdfLibrary() {
            try {
                if (window.pdfjsLib) {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    return true;
                }
            } catch (e) { console.error(e); }
            document.getElementById('lib-warning').classList.remove('hidden');
            return false;
        }

        // UI å…ƒç´ 
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadSection = document.getElementById('upload-section');
        const selectionSection = document.getElementById('selection-section');
        const selectionGrid = document.getElementById('selection-grid');
        const progressSection = document.getElementById('progress-section');
        const resultsSection = document.getElementById('results-section');
        const progressBar = document.getElementById('progress-bar');
        const progressTitle = document.getElementById('progress-title');
        const progressDetail = document.getElementById('progress-detail');
        const progressCount = document.getElementById('progress-count');
        const resultsGrid = document.getElementById('results-grid');
        const toast = document.getElementById('toast');
        const selectedCountSpan = document.getElementById('selected-count');

        // API Key ç®¡ç†
        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const apiKeyStatus = document.getElementById('api-key-status');
        const closeModalBtn = document.getElementById('close-modal');
        const saveApiKeyBtn = document.getElementById('save-api-key');
        const toggleVisibilityBtn = document.getElementById('toggle-visibility');

        function showApiKeyModal() {
            apiKeyModal.classList.remove('hidden');
            apiKeyInput.value = apiKey;
            apiKeyInput.focus();
            hasShownClipboardHint = false; // é‡ç½®æç¤ºç‹€æ…‹
        }

        function hideApiKeyModal() {
            apiKeyModal.classList.add('hidden');
        }

        function saveApiKey() {
            const newKey = apiKeyInput.value.trim();
            if (!newKey) {
                showToast('è«‹è¼¸å…¥ API Key', true);
                return;
            }
            if (!newKey.startsWith('AIza')) {
                showToast('API Key æ ¼å¼å¯èƒ½ä¸æ­£ç¢ºï¼ˆæ‡‰ä»¥ AIza é–‹é ­ï¼‰', true);
                return;
            }
            apiKey = newKey;
            localStorage.setItem('gemini_api_key', apiKey);
            hideApiKeyModal();
            updateApiKeyStatus();
            showToast('âœ“ API Key å·²å„²å­˜ï¼');
        }

        function updateApiKeyStatus() {
            if (apiKey && apiKey.trim() !== "") {
                const maskedKey = apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4);
                apiKeyStatus.innerHTML = `
                    <div class="flex items-center justify-between bg-emerald-500/10 border border-emerald-500/30 rounded-2xl p-4">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">âœ“</span>
                            <div>
                                <p class="font-bold text-emerald-400">API Key å·²è¨­å®š</p>
                                <p class="text-xs text-slate-300 font-mono">${maskedKey}</p>
                            </div>
                        </div>
                        <button onclick="showApiKeyModal()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-xl text-sm font-bold transition">
                            æ›´æ”¹
                        </button>
                    </div>
                `;
                apiKeyStatus.classList.remove('hidden');
            } else {
                apiKeyStatus.innerHTML = `
                    <div class="flex items-center justify-between bg-amber-500/10 border border-amber-500/30 rounded-2xl p-4">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">âš ï¸</span>
                            <div>
                                <p class="font-bold text-amber-400">éœ€è¦è¨­å®š API Key</p>
                                <p class="text-xs text-slate-300">å…è²»ç”³è«‹åªéœ€ 3 æ­¥é©Ÿï¼Œä¸ç”¨ä¿¡ç”¨å¡</p>
                            </div>
                        </div>
                        <button onclick="showApiKeyModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-xl text-sm font-bold transition">
                            ç«‹å³è¨­å®š
                        </button>
                    </div>
                `;
                apiKeyStatus.classList.remove('hidden');
            }
        }

        // åˆ‡æ› API Key å¯è¦‹æ€§
        let isKeyVisible = false;
        toggleVisibilityBtn.onclick = () => {
            isKeyVisible = !isKeyVisible;
            apiKeyInput.type = isKeyVisible ? 'text' : 'password';
            toggleVisibilityBtn.textContent = isKeyVisible ? 'ğŸ™ˆ' : 'ğŸ‘ï¸';
        };

        // è‡ªå‹•è²¼ä¸ŠåŠŸèƒ½
        document.getElementById('paste-from-clipboard').onclick = async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (text && text.trim().startsWith('AIza')) {
                    apiKeyInput.value = text.trim();
                    showToast('âœ“ å·²å¾å‰ªè²¼ç°¿è²¼ä¸Š API Key');
                } else if (text && text.trim()) {
                    apiKeyInput.value = text.trim();
                    showToast('âš ï¸ è²¼ä¸ŠæˆåŠŸï¼Œä½†æ ¼å¼å¯èƒ½ä¸æ­£ç¢º', true);
                } else {
                    showToast('å‰ªè²¼ç°¿æ˜¯ç©ºçš„ï¼Œè«‹å…ˆè¤‡è£½ API Key', true);
                }
            } catch (err) {
                showToast('ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è²¼ä¸Šï¼ˆCtrl+V æˆ– Cmd+Vï¼‰', true);
                apiKeyInput.focus();
            }
        };

        // é¡¯ç¤ºã€Œå·²æœ‰ API Key åœ¨å“ªæ‰¾ã€æç¤º
        document.getElementById('show-existing-key-tip').onclick = () => {
            const tip = `
æ‰¾åˆ°æ‚¨æ—¢æœ‰çš„ API Keyï¼š

1ï¸âƒ£ å‰å¾€ Google AI Studio
   https://aistudio.google.com/apikey

2ï¸âƒ£ ç™»å…¥æ‚¨çš„ Google å¸³è™Ÿ

3ï¸âƒ£ åœ¨ã€ŒAPI keysã€åˆ—è¡¨ä¸­ï¼š
   â€¢ å¦‚æœæœ‰ç¾æœ‰çš„ Keyï¼Œé»æ“Šã€Œè¤‡è£½ã€åœ–ç¤º
   â€¢ å¦‚æœæ²’æœ‰ï¼Œé»æ“Šã€ŒCreate API keyã€å»ºç«‹æ–°çš„

4ï¸âƒ£ è¤‡è£½å¾Œï¼Œé»æ“Šä¸Šæ–¹ã€ŒğŸ“‹ è‡ªå‹•è²¼ä¸Šã€æŒ‰éˆ•
            `;
            alert(tip);
        };

        // ç›£è½è¦–çª—ç²å¾—ç„¦é»äº‹ä»¶ï¼ˆç”¨æˆ¶å¯èƒ½å‰›å¾ Google AI Studio è¤‡è£½å›ä¾†ï¼‰
        let hasShownClipboardHint = false;
        window.addEventListener('focus', async () => {
            if (apiKeyModal.classList.contains('hidden')) return;
            if (apiKeyInput.value.trim()) return; // å·²ç¶“æœ‰å…§å®¹äº†
            if (hasShownClipboardHint) return; // å·²ç¶“æç¤ºéäº†

            try {
                const text = await navigator.clipboard.readText();
                if (text && text.trim().startsWith('AIza')) {
                    hasShownClipboardHint = true;
                    // é«˜äº®ã€Œè‡ªå‹•è²¼ä¸Šã€æŒ‰éˆ•
                    const pasteBtn = document.getElementById('paste-from-clipboard');
                    pasteBtn.classList.add('animate-pulse');
                    showToast('ğŸ’¡ åµæ¸¬åˆ°å‰ªè²¼ç°¿ä¸­æœ‰ API Keyï¼Œé»æ“Šã€Œè‡ªå‹•è²¼ä¸Šã€å³å¯', false);
                    setTimeout(() => pasteBtn.classList.remove('animate-pulse'), 3000);
                }
            } catch (err) {
                // æŸäº›ç€è¦½å™¨ä¸å…è¨±åœ¨èƒŒæ™¯è®€å–å‰ªè²¼ç°¿ï¼Œå¿½ç•¥éŒ¯èª¤
            }
        });

        // äº‹ä»¶ç›£è½
        closeModalBtn.onclick = () => {
            if (!apiKey || apiKey.trim() === "") {
                if (!confirm('å°šæœªè¨­å®š API Keyï¼Œéƒ¨åˆ†åŠŸèƒ½å°‡ç„¡æ³•ä½¿ç”¨ã€‚ç¢ºå®šè¦é—œé–‰å—ï¼Ÿ')) {
                    return;
                }
            }
            hideApiKeyModal();
        };
        saveApiKeyBtn.onclick = saveApiKey;
        apiKeyInput.onkeypress = (e) => {
            if (e.key === 'Enter') saveApiKey();
        };

        // ç›£è½æ‰‹å‹•è²¼ä¸Šäº‹ä»¶
        apiKeyInput.addEventListener('paste', (e) => {
            setTimeout(() => {
                const value = apiKeyInput.value.trim();
                if (value.startsWith('AIza')) {
                    showToast('âœ“ API Key æ ¼å¼æ­£ç¢º', false);
                } else if (value) {
                    showToast('âš ï¸ è«‹ç¢ºèª API Key æ ¼å¼ï¼ˆæ‡‰ä»¥ AIza é–‹é ­ï¼‰', true);
                }
            }, 100);
        });

        // å°‡ showApiKeyModal è¨­ç‚ºå…¨åŸŸå‡½æ•¸
        window.showApiKeyModal = showApiKeyModal;

        // åˆå§‹åŒ–æª¢æŸ¥ (Window Load)
        window.onload = () => {
            initPdfLibrary();
            updateApiKeyStatus();

            // å¦‚æœæ²’æœ‰ API Keyï¼Œè‡ªå‹•é¡¯ç¤ºè¨­å®šç•«é¢
            if (!apiKey || apiKey.trim() === "") {
                setTimeout(() => showApiKeyModal(), 500);
            }
        };

        function showToast(msg, isError = false) {
            toast.textContent = msg;
            toast.style.backgroundColor = isError ? '#ef4444' : '#1e293b';
            toast.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 3000);
        }

        const wait = (ms) => new Promise(res => setTimeout(res, ms));

        async function fetchWithRetry(url, options, maxRetries = 5) {
            const delays = [2000, 4000, 8000, 16000, 32000];
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);

                    // æª¢æŸ¥å›æ‡‰æ˜¯å¦ç‚ºç©º
                    const text = await response.text();
                    if (!text) {
                        throw new Error(`API å›æ‡‰ç‚ºç©º (HTTP ${response.status})`);
                    }

                    // å˜—è©¦è§£æ JSON
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (jsonError) {
                        throw new Error(`API å›æ‡‰æ ¼å¼éŒ¯èª¤: ${text.substring(0, 100)}`);
                    }

                    if (response.ok) return data;

                    if (response.status === 429) {
                        const waitTime = delays[i] || 10000;
                        showToast(`API é »ç‡é™åˆ¶ (429)ï¼Œç­‰å¾… ${waitTime/1000} ç§’å¾Œé‡è©¦...`, true);
                        await wait(waitTime);
                        continue;
                    }

                    throw new Error(data.error?.message || `HTTP ${response.status}`);
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                    await wait(2000);
                }
            }
        }

        // æ‹–æ”¾äº‹ä»¶
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = e => handleFiles(e.target.files);
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('drop-zone-active'); };
        dropZone.ondragleave = () => dropZone.classList.remove('drop-zone-active');
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-zone-active');
            handleFiles(e.dataTransfer.files);
        };

        // æ­¥é©Ÿ 1: è®€å–æª”æ¡ˆä¸¦ç”Ÿæˆç¸®åœ–
        async function handleFiles(files) {
            if (!initPdfLibrary()) return;
            if (!files || files.length === 0) return;

            // é¡¯ç¤ºè®€å–ä¸­ç‹€æ…‹
            dropZone.innerHTML = `<div class="loader mx-auto mb-4"></div><p class="text-slate-300">æ­£åœ¨è®€å–ä¸¦å»ºç«‹ç¸®åœ–...</p>`;
            dropZone.style.pointerEvents = 'none';

            pendingItems = []; // é‡ç½®å¾…è™•ç†æ¸…å–®

            try {
                for (let file of files) {
                    const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                    const isImage = file.type.startsWith('image/') || /\.(jpg|jpeg|png|webp|bmp)$/i.test(file.name);

                    if (isPdf) {
                        await loadPdfAndGenerateThumbs(file);
                    } else if (isImage) {
                        const base64 = await fileToBase64(file);
                        pendingItems.push({
                            id: `img_${Date.now()}_${Math.random()}`,
                            type: 'image',
                            name: file.name,
                            thumb: base64, // åœ–ç‰‡ç›´æ¥ç”¨åŸåœ–ç•¶ç¸®åœ–
                            original: base64,
                            selected: true // é è¨­é¸ä¸­
                        });
                    }
                }

                if (pendingItems.length > 0) {
                    renderSelectionGrid();
                } else {
                    showToast('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼', true);
                    location.reload();
                }
            } catch (err) {
                console.error(err);
                showToast(err.message || 'æª”æ¡ˆè®€å–å¤±æ•—', true);
                setTimeout(() => location.reload(), 2000);
            }
        }

        // è®€å– PDF ä¸¦ç”¢ç”Ÿä½è§£æç¸®åœ–
        async function loadPdfAndGenerateThumbs(file) {
            const arrayBuffer = await file.arrayBuffer();
            const lib = window.pdfjsLib;

            const pdfDoc = await lib.getDocument({
                data: arrayBuffer,
                cMapUrl: 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/cmaps/',
                cMapPacked: true
            }).promise;

            const total = pdfDoc.numPages;

            for (let i = 1; i <= total; i++) {
                const page = await pdfDoc.getPage(i);
                // ä½¿ç”¨ä½ Scale (0.5) å¿«é€Ÿç”Ÿæˆç¸®åœ–
                const viewport = page.getViewport({ scale: 0.5 });
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: ctx, viewport }).promise;

                pendingItems.push({
                    id: `pdf_${file.name}_${i}`,
                    type: 'pdf',
                    name: `${file.name} - P${i}`,
                    thumb: canvas.toDataURL('image/jpeg', 0.6).split(',')[1],
                    pdfDoc: pdfDoc, // ä¿å­˜æ–‡æª”å¼•ç”¨ä»¥ä¾¿ç¨å¾Œé«˜æ¸…æ¸²æŸ“
                    pageNum: i,
                    selected: true // é è¨­é¸ä¸­
                });
            }
        }

        // æ­¥é©Ÿ 2: æ¸²æŸ“é¸æ“‡ä»‹é¢
        function renderSelectionGrid() {
            uploadSection.classList.add('hidden');
            selectionSection.classList.remove('hidden');
            selectionGrid.innerHTML = '';

            pendingItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'relative group';
                div.innerHTML = `
                    <label class="cursor-pointer block relative">
                        <input type="checkbox" class="custom-checkbox hidden" ${item.selected ? 'checked' : ''} onchange="toggleSelection(${index}, this.checked)">
                        <div class="glass rounded-xl overflow-hidden border-2 border-transparent transition-all h-32 md:h-40 flex flex-col relative">
                            <img src="data:image/jpeg;base64,${item.thumb}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">

                            <!-- å‹¾é¸ç‹€æ…‹é®ç½© -->
                            <div class="check-icon absolute top-2 right-2 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg transform scale-0 transition-transform duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
                            </div>

                            <div class="absolute bottom-0 left-0 right-0 bg-black/60 p-1 text-[10px] text-center truncate text-white backdrop-blur-sm">
                                ${item.name}
                            </div>
                        </div>
                    </label>
                `;
                selectionGrid.appendChild(div);
            });
            updateSelectedCount();
        }

        window.toggleSelection = (index, isChecked) => {
            pendingItems[index].selected = isChecked;
            updateSelectedCount();
        };

        function updateSelectedCount() {
            const count = pendingItems.filter(i => i.selected).length;
            selectedCountSpan.textContent = count;
            document.getElementById('start-process-btn').disabled = count === 0;
            document.getElementById('start-process-btn').classList.toggle('opacity-50', count === 0);
        }

        // å…¨é¸/å…¨å–æ¶ˆ
        document.getElementById('select-all-btn').onclick = () => {
            pendingItems.forEach(i => i.selected = true);
            renderSelectionGrid();
        };
        document.getElementById('deselect-all-btn').onclick = () => {
            pendingItems.forEach(i => i.selected = false);
            renderSelectionGrid();
        };

        // æ­¥é©Ÿ 3: é–‹å§‹è™•ç†é¸ä¸­çš„é …ç›®
        document.getElementById('start-process-btn').onclick = async () => {
            const selectedItems = pendingItems.filter(i => i.selected);
            if (selectedItems.length === 0) return;

            selectionSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');

            // é–‹å§‹è™•ç†æµç¨‹
            await processSelectedItems(selectedItems);
        };

        async function processSelectedItems(items) {
            // æª¢æŸ¥ API Key
            if (!apiKey || apiKey.trim() === "") {
                showToast("âŒ è«‹å…ˆè¨­å®š API Key", true);
                progressSection.classList.add('hidden');
                selectionSection.classList.remove('hidden');
                showApiKeyModal();
                return;
            }

            results = [];
            resultsGrid.innerHTML = '';
            resultsSection.classList.remove('hidden');

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                let processBase64 = item.thumb; // é è¨­

                progressTitle.textContent = `è™•ç†ä¸­: ${item.name}`;
                progressCount.textContent = `${i + 1}/${items.length}`;
                progressBar.style.width = `${((i + 1) / items.length) * 100}%`;

                // å¦‚æœæ˜¯ PDFï¼Œé€™è£¡æ‰é€²è¡Œé«˜æ¸…æ¸²æŸ“ (Scale 2.0)
                if (item.type === 'pdf') {
                    progressDetail.textContent = "æ­£åœ¨ç”Ÿæˆé«˜è§£æå½±åƒ...";
                    try {
                        const page = await item.pdfDoc.getPage(item.pageNum);
                        const viewport = page.getViewport({ scale: 2.0 }); // é«˜è§£æåº¦
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: ctx, viewport }).promise;
                        processBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    } catch (e) {
                        console.error("Re-render error", e);
                        // è‹¥å¤±æ•—å‰‡é™ç´šä½¿ç”¨ç¸®åœ–
                    }
                } else {
                    processBase64 = item.original;
                }

                progressDetail.textContent = "AI æ­£åœ¨ç§»é™¤æ–‡å­—ä¸¦é‡å»ºèƒŒæ™¯...";

                try {
                    const cleaned = await removeTextWithGemini(processBase64);
                    results.push({ name: item.name, original: processBase64, cleaned });
                    addResultCard(i, item.name, cleaned);
                } catch (e) {
                    console.error(e);
                    const isAuthError = e.message.includes("400") || e.message.includes("403") || e.message.includes("key");
                    const errMsg = isAuthError ? "API Key ç„¡æ•ˆæˆ–ç’°å¢ƒç•°å¸¸" : e.message;
                    results.push({ name: item.name, original: processBase64, cleaned: null, error: errMsg });
                    addResultCard(i, item.name, null, errMsg);
                }

                if (i < items.length - 1) await wait(3500);
            }
            setTimeout(() => progressSection.classList.add('hidden'), 1000);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function removeTextWithGemini(base64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE_EDIT}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [
                        { text: "Remove all text and numbers. Reconstruct background. Return only image." },
                        { inlineData: { mimeType: "image/png", data: base64 } }
                    ]
                }],
                generationConfig: { responseModalities: ['IMAGE'] }
            };

            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const part = data.candidates?.[0]?.content?.parts?.find(p => p.inlineData);
            if (!part) throw new Error(data.error?.message || "API æœªè¿”å›å½±åƒæ•¸æ“š");
            return part.inlineData.data;
        }

        async function ocrWithGemini(base64) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT_GEN}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{
                    parts: [
                        { text: "Extract text blocks with positions [ymin, xmin, ymax, xmax] (0-1000). Return JSON array." },
                        { inlineData: { mimeType: "image/png", data: base64 } }
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                text: { type: "STRING" },
                                box_2d: { type: "ARRAY", items: { type: "NUMBER" }, minItems: 4, maxItems: 4 },
                                font_size: { type: "NUMBER" },
                                color: { type: "STRING" }
                            }
                        }
                    }
                }
            };

            const data = await fetchWithRetry(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                throw new Error("OCR è¾¨è­˜å¤±æ•—æˆ–ç„¡æ–‡å­—å…§å®¹");
            }

            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        function addResultCard(index, name, cleaned, error) {
            const div = document.createElement('div');
            div.className = 'result-card glass rounded-2xl overflow-hidden';
            if (cleaned) {
                div.innerHTML = `
                    <img src="data:image/png;base64,${cleaned}" class="w-full aspect-video object-cover">
                    <div class="p-4 flex justify-between items-center text-[10px]">
                        <span class="truncate max-w-[80%]">${name}</span>
                        <span class="text-emerald-400 font-bold">æˆåŠŸ</span>
                    </div>
                `;
            } else {
                div.innerHTML = `<div class="p-6 text-center text-red-400 text-[10px]">${error || 'å¤±æ•—'}</div>`;
            }
            resultsGrid.appendChild(div);
        }

        document.getElementById('export-combined-btn').onclick = async () => {
            const valid = results.filter(r => r.cleaned);
            if (!valid.length) return;

            const btn = document.getElementById('export-combined-btn');
            btn.disabled = true;
            btn.innerHTML = "æ­£åœ¨è¾¨è­˜æ–‡å­—...";

            try {
                const pptx = new PptxGenJS();
                const ratio = document.getElementById('ratio-select').value;
                pptx.layout = ratio === '16:9' ? 'LAYOUT_WIDE' : ratio === '4:3' ? 'LAYOUT_4x3' : 'LAYOUT_WIDE';

                for (let i = 0; i < valid.length; i++) {
                    const r = valid[i];
                    showToast(`è¾¨è­˜ä¸­ (${i+1}/${valid.length})...`);
                    const slide = pptx.addSlide();
                    slide.addImage({ data: `data:image/png;base64,${r.cleaned}`, x: 0, y: 0, w: '100%', h: '100%' });

                    try {
                        const blocks = await ocrWithGemini(r.original);
                        blocks.forEach(b => {
                            const [ymin, xmin, ymax, xmax] = b.box_2d;
                            slide.addText(b.text || "", {
                                x: `${xmin/10}%`, y: `${ymin/10}%`,
                                w: `${(xmax-xmin)/10}%`, h: `${(ymax-ymin)/10}%`,
                                fontSize: b.font_size || 14,
                                color: (b.color || "000000").replace("#", ""),
                                fontFace: 'Microsoft JhengHei'
                            });
                        });
                    } catch (e) { console.warn("OCR skip"); }
                    if (i < valid.length - 1) await wait(3500);
                }
                pptx.writeFile({ fileName: `Result_${Date.now()}.pptx` });
                showToast('å°å‡ºæˆåŠŸ');
            } catch (e) { showToast("å°å‡ºå¤±æ•—", true); }
            btn.disabled = false;
            btn.innerHTML = "åˆä½µ PPTX â­";
        };

        document.getElementById('reset-btn').onclick = () => location.reload();
    </script>
</body>
</html>
